# 账号付费与AI配额系统设计文档

## 1. 概述

### 1.1 设计目标

本文档定义 SillyChat 的账号付费体系与AI配额管理系统，实现：

- 灵活的账号类型满足不同用户需求
- 清晰的AI配额管理机制
- 支持多种模型接入方式
- 完善的计费与支付系统
- 与OpenClaw生态的无缝打通

### 1.2 核心概念

| 概念 | 说明 |
|------|------|
| **账号类型** | 基础版/专业版/企业版，决定AI数量上限和功能权限 |
| **AI配额** | 每个账号可配置的AI代理数量上限 |
| **Channel** | 接入的OpenClaw设备或付费模型通道 |
| **模型来源** | 自带OpenClaw / 平台付费模型 / 混合模式 |
| **计费单元** | 订阅费用 + 用量费用（按token或请求次数） |

---

## 2. 账号类型设计

### 2.1 账号类型对比

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        账号类型体系                                      │
├──────────────┬──────────────┬──────────────┬────────────────────────────┤
│    特性      │   基础版      │   专业版      │      企业版               │
├──────────────┼──────────────┼──────────────┼────────────────────────────┤
│  AI数量上限   │    1个       │    5个       │       无限                │
│  Channel数量  │    1个       │    5个       │       无限                │
│  自带OpenClaw │    支持      │    支持      │       支持                │
│  付费模型     │    支持      │    支持      │       支持                │
│  混合模式     │    不支持    │    支持      │       支持                │
│  Skills市场   │    基础      │    完整      │       完整+定制           │
│  云端同步     │    基础版    │    完整版    │       完整版+私有化部署   │
│  技术支持     │    社区      │    邮件      │       专属+SLA            │
│  API访问      │    不支持    │    只读      │       完整                │
│  团队协作     │    不支持    │    5人       │       无限                │
├──────────────┼──────────────┼──────────────┼────────────────────────────┤
│  月订阅价格   │    免费      │    ¥29/月    │       ¥199/月起           │
│  年订阅优惠   │    -         │    ¥290/年   │       ¥1990/年起          │
└──────────────┴──────────────┴──────────────┴────────────────────────────┘
```

### 2.2 账号类型详细定义

#### 2.2.1 基础版 (Free)

```typescript
interface FreePlan {
  id: 'free';
  name: '基础版';

  // AI配额
  aiQuota: {
    maxAgents: 1;           // 最多1个AI
    maxChannels: 1;         // 最多1个Channel
    allowMixedMode: false;  // 不支持混合模式
  };

  // 模型接入
  modelAccess: {
    openclaw: {
      enabled: true;        // 支持自带OpenClaw
      maxDevices: 1;        // 最多1个设备
    };
    platformModels: {
      enabled: true;        // 支持平台模型
      availableModels: ['gpt-3.5-turbo', 'claude-instant'];
      monthlyTokens: 100000; // 每月10万token
    };
  };

  // 功能限制
  features: {
    skills: 'basic';        // 仅基础Skills
    cloudSync: 'basic';     // 基础同步
    fileStorage: 100 * 1024 * 1024; // 100MB存储
    messageHistory: 30;     // 30天历史
  };

  // 价格
  pricing: {
    monthly: 0;
    yearly: 0;
  };
}
```

#### 2.2.2 专业版 (Pro)

```typescript
interface ProPlan {
  id: 'pro';
  name: '专业版';

  // AI配额
  aiQuota: {
    maxAgents: 5;           // 最多5个AI
    maxChannels: 5;         // 最多5个Channel
    allowMixedMode: true;   // 支持混合模式
  };

  // 模型接入
  modelAccess: {
    openclaw: {
      enabled: true;
      maxDevices: 5;        // 最多5个设备
    };
    platformModels: {
      enabled: true;
      availableModels: ['*']; // 所有可用模型
      monthlyTokens: 1000000; // 每月100万token
      overageRate: 0.002;     // 超额单价 $/1K tokens
    };
  };

  // 功能
  features: {
    skills: 'full';         // 完整Skills市场
    cloudSync: 'full';      // 完整同步
    fileStorage: 10 * 1024 * 1024 * 1024; // 10GB存储
    messageHistory: -1;     // 永久历史
    teamSize: 5;            // 最多5人团队
  };

  // 价格
  pricing: {
    monthly: 29;            // ¥29/月
    yearly: 290;            // ¥290/年 (2个月免费)
  };
}
```

#### 2.2.3 企业版 (Enterprise)

```typescript
interface EnterprisePlan {
  id: 'enterprise';
  name: '企业版';

  // AI配额
  aiQuota: {
    maxAgents: -1;          // 无限AI
    maxChannels: -1;        // 无限Channel
    allowMixedMode: true;   // 支持混合模式
  };

  // 模型接入
  modelAccess: {
    openclaw: {
      enabled: true;
      maxDevices: -1;       // 无限设备
    };
    platformModels: {
      enabled: true;
      availableModels: ['*']; // 所有模型
      monthlyTokens: -1;      // 无限token
      customModels: true;     // 支持自定义模型
    };
  };

  // 功能
  features: {
    skills: 'custom';       // 定制Skills
    cloudSync: 'private';   // 私有化部署选项
    fileStorage: -1;        // 无限存储
    messageHistory: -1;     // 永久历史
    teamSize: -1;           // 无限团队
    sso: true;              // SSO集成
    auditLog: true;         // 审计日志
    sla: '99.9%';           // SLA保障
  };

  // 价格
  pricing: {
    monthly: 199;           // ¥199/月起
    yearly: 1990;           // ¥1990/年起
    custom: true;           // 支持定制报价
  };
}
```

### 2.3 账号升级/降级流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     账号变更流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   升级流程 (Free -> Pro -> Enterprise)                         │
│   ─────────────────────────────────────                        │
│                                                                 │
│   用户发起升级                                                  │
│        │                                                        │
│        ▼                                                        │
│   选择目标套餐                                                  │
│        │                                                        │
│        ▼                                                        │
│   计算价格差额 (按剩余天数比例)                                  │
│        │                                                        │
│        ▼                                                        │
│   支付差额                                                      │
│        │                                                        │
│        ▼                                                        │
│   立即生效新配额                                                │
│        │                                                        │
│        ▼                                                        │
│   保留原有AI配置                                                │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   降级流程 (Enterprise -> Pro -> Free)                         │
│   ─────────────────────────────────────                        │
│                                                                 │
│   用户发起降级                                                  │
│        │                                                        │
│        ▼                                                        │
│   检查当前AI数量是否超出目标套餐限制                             │
│        │                                                        │
│        ├── 超出 ──► 提示用户删除多余AI                          │
│        │                                                        │
│        └── 未超出 ──► 继续                                      │
│                        │                                        │
│                        ▼                                        │
│                计算退款金额 (按剩余天数比例)                     │
│                        │                                        │
│                        ▼                                        │
│                确认降级                                         │
│                        │                                        │
│                        ▼                                        │
│                当前计费周期结束生效                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. AI配额管理系统

### 3.1 配额模型设计

```typescript
// 账号配额配置
interface AccountQuota {
  accountId: string;
  planId: 'free' | 'pro' | 'enterprise';

  // AI配额
  ai: {
    total: number;          // 总数上限 (-1表示无限)
    used: number;           // 已使用
    available: number;      // 可用数量

    // 各类型AI限制
    byType: {
      master: { max: number; used: number; };      // 主人AI
      assistant: { max: number; used: number; };   // 助手AI
      expert: { max: number; used: number; };      // 专家AI
    };
  };

  // Channel配额
  channels: {
    total: number;          // 总数上限
    used: number;           // 已使用
    available: number;      // 可用数量

    // 各类型Channel限制
    byType: {
      openclaw: { max: number; used: number; };    // OpenClaw设备
      platform: { max: number; used: number; };    // 平台模型
    };
  };

  // 用量配额
  usage: {
    tokens: {
      monthly: number;      // 每月token上限 (-1表示无限)
      used: number;         // 本月已使用
      resetDate: Date;      // 重置日期
    };
    storage: {
      total: number;        // 存储上限 (-1表示无限)
      used: number;         // 已使用
    };
    requests: {
      daily: number;        // 每日请求上限
      used: number;         // 今日已使用
      resetHour: number;    // 重置小时 (UTC)
    };
  };
}
```

### 3.2 配额分配策略

```
┌─────────────────────────────────────────────────────────────────┐
│                     配额分配架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   账号层级 (Account)                                            │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  总配额: 由订阅套餐决定                                    │
│   │  - Free: 1 AI, 1 Channel, 100K tokens/月                │
│   │  - Pro: 5 AI, 5 Channels, 1M tokens/月                  │
│   │  - Enterprise: 无限                                       │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│           ┌──────────────────┼──────────────────┐               │
│           ▼                  ▼                  ▼               │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│   │   AI配额      │  │ Channel配额   │  │  用量配额     │         │
│   │  - 数量限制   │  │  - 数量限制   │  │  - Token     │         │
│   │  - 类型限制   │  │  - 类型限制   │  │  - 存储      │         │
│   └──────────────┘  └──────────────┘  └──────────────┘         │
│           │                  │                  │               │
│           ▼                  ▼                  ▼               │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    实际分配                               │   │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │   │
│   │  │  AI #1  │  │  AI #2  │  │  AI #3  │  │ Channel │    │   │
│   │  │ Master  │  │Assistant│  │ Expert  │  │ OpenClaw│    │   │
│   │  └─────────┘  └─────────┘  └─────────┘  └─────────┘    │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 使用量统计

#### 3.3.1 统计维度

```typescript
interface UsageMetrics {
  // Token使用统计
  tokens: {
    total: number;          // 总token数
    input: number;          // 输入token
    output: number;         // 输出token

    // 按模型统计
    byModel: Map<string, {
      total: number;
      input: number;
      output: number;
      cost: number;         // 费用
    }>;

    // 按AI代理统计
    byAgent: Map<string, {
      total: number;
      requests: number;
      cost: number;
    }>;

    // 按时间统计
    byTime: {
      hourly: Map<number, number>;   // 每小时
      daily: Map<string, number>;    // 每天
      monthly: Map<string, number>;  // 每月
    };
  };

  // 请求统计
  requests: {
    total: number;          // 总请求数
    success: number;        // 成功数
    failed: number;         // 失败数
    cached: number;         // 缓存命中数

    // 按类型统计
    byType: {
      chat: number;
      skill: number;
      tool: number;
      file: number;
    };
  };

  // 存储统计
  storage: {
    total: number;          // 总存储(字节)
    files: number;          // 文件数量
    messages: number;       // 消息数量

    // 按类型统计
    byType: {
      images: number;
      documents: number;
      videos: number;
      other: number;
    };
  };
}
```

#### 3.3.2 统计API

```typescript
// 获取用量统计
interface GetUsageAPI {
  // 请求
  request: {
    accountId: string;
    startDate: Date;
    endDate: Date;
    granularity: 'hour' | 'day' | 'week' | 'month';
    dimensions?: ('model' | 'agent' | 'channel' | 'type')[];
  };

  // 响应
  response: {
    summary: {
      totalTokens: number;
      totalCost: number;
      totalRequests: number;
      avgLatency: number;
    };
    timeline: Array<{
      timestamp: Date;
      tokens: number;
      cost: number;
      requests: number;
    }>;
    breakdown: {
      byModel: Record<string, UsageStats>;
      byAgent: Record<string, UsageStats>;
      byChannel: Record<string, UsageStats>;
    };
  };
}
```

### 3.4 超额处理机制

```
┌─────────────────────────────────────────────────────────────────┐
│                     超额处理流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Token超额处理                                                 │
│   ─────────────                                                │
│                                                                 │
│   使用达到80%                                                   │
│        │                                                        │
│        ▼                                                        │
│   发送预警通知 (邮件/应用内)                                     │
│        │                                                        │
│        ▼                                                        │
│   使用达到100%                                                  │
│        │                                                        │
│        ├── 免费版 ──► 停止服务，提示升级                        │
│        │                                                        │
│        ├── 专业版 ──► 启用超额计费                               │
│        │              - 按量收费                                 │
│        │              - 继续服务                                 │
│        │                                                        │
│        └── 企业版 ──► 无限制                                     │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   AI数量超额处理                                                │
│   ────────────────                                             │
│                                                                 │
│   创建新AI时检查配额                                             │
│        │                                                        │
│        ├── 有可用配额 ──► 允许创建                              │
│        │                                                        │
│        └── 无可用配额 ──► 拒绝创建                              │
│                      │                                          │
│                      ├── 免费版 ──► 提示升级专业版               │
│                      │                                          │
│                      └── 付费版 ──► 提示购买额外配额包           │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   降级时超额处理                                                │
│   ────────────────                                             │
│                                                                 │
│   用户降级套餐                                                  │
│        │                                                        │
│        ▼                                                        │
│   检查当前AI数量 > 新套餐限制                                    │
│        │                                                        │
│        ├── 是 ──► 要求用户选择保留的AI                          │
│        │         冻结多余AI (不可使用但保留配置)                 │
│        │         30天内未处理则自动删除                          │
│        │                                                        │
│        └── 否 ──► 正常降级                                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 模型接入系统

### 4.1 接入方式总览

```
┌─────────────────────────────────────────────────────────────────┐
│                     模型接入架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                   SillyChat                          │   │
│   │                      用户账号                             │   │
│   └──────────────────────┬──────────────────────────────────┘   │
│                          │                                      │
│           ┌──────────────┼──────────────┐                       │
│           ▼              ▼              ▼                       │
│   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │
│   │  自带OpenClaw │ │  平台付费模型 │ │   混合模式    │           │
│   │   (Channel)   │ │   (API)      │ │  (Hybrid)    │           │
│   └──────┬───────┘ └──────┬───────┘ └──────┬───────┘           │
│          │                │                │                    │
│          ▼                ▼                ▼                    │
│   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │
│   │ 用户自有设备  │ │ 平台统一接入  │ │  智能路由     │           │
│   │ - 本地部署    │ │ - OpenAI     │ │  自动选择     │           │
│   │ - 远程设备    │ │ - Anthropic  │ │  最优模型     │           │
│   │ - 多设备管理  │ │ - 国产模型    │ │              │           │
│   └──────────────┘ └──────────────┘ └──────────────┘           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 自带OpenClaw接入

#### 4.2.1 接入配置

```typescript
interface OpenClawChannel {
  id: string;
  type: 'openclaw';
  name: string;

  // 连接配置
  connection: {
    deviceId: string;           // OpenClaw设备ID
    apiKey: string;             // API密钥 (加密存储)
    wsUrl: string;              // WebSocket地址
    httpUrl?: string;           // HTTP API地址
  };

  // 能力配置
  capabilities: {
    models: string[];           // 支持的模型列表
    skills: boolean;            // 是否支持Skills
    fileAccess: boolean;        // 是否支持文件访问
  };

  // 状态
  status: 'connected' | 'disconnected' | 'error';
  lastConnectedAt?: Date;

  // 关联AI
  assignedAgents: string[];     // 分配给哪些AI使用
}
```

#### 4.2.2 接入流程

```
┌─────────────────────────────────────────────────────────────────┐
│                   OpenClaw接入流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   1. 添加设备                                                   │
│   ───────────                                                  │
│                                                                 │
│   用户点击"添加OpenClaw设备"                                     │
│        │                                                        │
│        ▼                                                        │
│   输入设备信息：                                                 │
│   - 设备ID (从OpenClaw获取)                                     │
│   - API Key (从OpenClaw获取)                                    │
│   - WebSocket URL                                               │
│        │                                                        │
│        ▼                                                        │
│   系统验证连接                                                  │
│        │                                                        │
│        ├── 成功 ──► 保存配置，创建Channel                        │
│        │                                                        │
│        └── 失败 ──► 显示错误信息                                 │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   2. 设备管理                                                   │
│   ───────────                                                  │
│                                                                 │
│   每个OpenClaw设备作为一个Channel：                              │
│   - 设备数量 = AI数量 (1个设备 = 1个AI)                         │
│   - 可分配给特定AI使用                                          │
│   - 支持多设备同时在线                                          │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   3. 消息路由                                                   │
│   ───────────                                                  │
│                                                                 │
│   用户发送消息                                                  │
│        │                                                        │
│        ▼                                                        │
│   确定目标AI                                                    │
│        │                                                        │
│        ▼                                                        │
│   检查AI绑定的Channel                                           │
│        │                                                        │
│        ├── OpenClaw Channel ──► 转发到OpenClaw设备               │
│        │                                                        │
│        └── Platform Channel ──► 调用平台API                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 付费模型API接入

#### 4.3.1 支持的模型提供商

```typescript
interface ModelProvider {
  id: string;
  name: string;
  enabled: boolean;

  // 配置
  config: {
    baseUrl: string;
    apiKeyRequired: boolean;
    models: ModelInfo[];
  };

  // 计费
  pricing: {
    inputPrice: number;     // $/1M tokens
    outputPrice: number;    // $/1M tokens
    currency: 'USD' | 'CNY';
  };
}

// 平台支持的模型提供商
const PLATFORM_PROVIDERS: ModelProvider[] = [
  {
    id: 'openai',
    name: 'OpenAI',
    enabled: true,
    config: {
      baseUrl: 'https://api.openai.com/v1',
      apiKeyRequired: false,  // 平台统一提供
      models: [
        { id: 'gpt-4o', name: 'GPT-4o', context: 128000 },
        { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', context: 128000 },
        { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', context: 16385 },
      ],
    },
    pricing: { inputPrice: 5.0, outputPrice: 15.0, currency: 'USD' },
  },
  {
    id: 'anthropic',
    name: 'Anthropic',
    enabled: true,
    config: {
      baseUrl: 'https://api.anthropic.com',
      apiKeyRequired: false,
      models: [
        { id: 'claude-3-5-sonnet', name: 'Claude 3.5 Sonnet', context: 200000 },
        { id: 'claude-3-opus', name: 'Claude 3 Opus', context: 200000 },
        { id: 'claude-3-haiku', name: 'Claude 3 Haiku', context: 200000 },
      ],
    },
    pricing: { inputPrice: 3.0, outputPrice: 15.0, currency: 'USD' },
  },
  {
    id: 'aliyun',
    name: '阿里云百炼',
    enabled: true,
    config: {
      baseUrl: 'https://dashscope.aliyuncs.com',
      apiKeyRequired: false,
      models: [
        { id: 'qwen-max', name: '通义千问Max', context: 32000 },
        { id: 'qwen-plus', name: '通义千问Plus', context: 32000 },
        { id: 'qwen-turbo', name: '通义千问Turbo', context: 32000 },
      ],
    },
    pricing: { inputPrice: 0.02, outputPrice: 0.06, currency: 'CNY' },
  },
];
```

#### 4.3.2 平台Channel配置

```typescript
interface PlatformChannel {
  id: string;
  type: 'platform';
  name: string;

  // 模型配置
  model: {
    provider: string;       // 提供商ID
    modelId: string;        // 模型ID
    options: {
      temperature?: number;
      maxTokens?: number;
      topP?: number;
    };
  };

  // 配额使用
  usage: {
    tokensUsed: number;     // 已使用token
    requestsMade: number;   // 已发起请求
    cost: number;           // 累计费用
  };

  // 限制
  limits: {
    maxTokensPerRequest?: number;
    rateLimit?: number;     // 每分钟请求数
  };

  // 关联AI
  assignedAgents: string[];
}
```

### 4.4 混合模式

#### 4.4.1 智能路由

```typescript
interface HybridRouting {
  enabled: boolean;
  strategy: 'cost' | 'quality' | 'speed' | 'manual';

  // 路由规则
  rules: Array<{
    name: string;
    condition: RoutingCondition;
    priority: number;
    target: 'openclaw' | 'platform' | 'auto';
  }>;

  // 回退配置
  fallback: {
    enabled: boolean;
    order: ('openclaw' | 'platform')[];
    timeout: number;        // 超时时间(秒)
  };
}

// 路由条件
interface RoutingCondition {
  type: 'model' | 'skill' | 'file' | 'time' | 'cost';
  operator: 'eq' | 'ne' | 'gt' | 'lt' | 'in' | 'contains';
  value: unknown;
}
```

#### 4.4.2 混合模式工作流

```
┌─────────────────────────────────────────────────────────────────┐
│                   混合模式路由流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   用户发送请求                                                  │
│        │                                                        │
│        ▼                                                        │
│   分析请求特征                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ - 消息长度                                               │   │
│   │ - 是否涉及文件                                           │   │
│   │ - 是否调用Skill                                          │   │
│   │ - 期望响应时间                                           │   │
│   │ - 历史上下文长度                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│        │                                                        │
│        ▼                                                        │
│   应用路由规则                                                   │
│        │                                                        │
│        ├── 规则命中 ──► 按规则路由到指定Channel                  │
│        │                                                        │
│        └── 无规则 ──► 按策略自动选择                             │
│              │                                                  │
│              ├── cost策略 ──► 选择成本最低的可用Channel          │
│              │                                                  │
│              ├── quality策略 ──► 选择质量最优的模型              │
│              │                                                  │
│              ├── speed策略 ──► 选择响应最快的Channel             │
│              │                                                  │
│              └── manual策略 ──► 提示用户选择                     │
│                                                                 │
│        │                                                        │
│        ▼                                                        │
│   执行请求                                                       │
│        │                                                        │
│        ├── 成功 ──► 返回结果                                    │
│        │                                                        │
│        └── 失败 ──► 启用回退机制                                 │
│              │                                                  │
│              ├── 有备用Channel ──► 尝试下一个                     │
│              │                                                  │
│              └── 无备用 ──► 返回错误                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. 计费系统

### 5.1 计费模式

```
┌─────────────────────────────────────────────────────────────────┐
│                     计费体系                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   订阅费用 (固定)                                               │
│   ────────────────                                             │
│                                                                 │
│   ┌──────────────┬──────────────┬──────────────┐               │
│   │   基础版     │   专业版     │   企业版     │               │
│   │    免费      │   ¥29/月     │  ¥199/月    │               │
│   └──────────────┴──────────────┴──────────────┘               │
│                                                                 │
│   包含:                                                         │
│   - 基础AI配额                                                  │
│   - 基础Token额度                                               │
│   - 基础存储空间                                                │
│   - 基础功能权限                                                │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   用量费用 (按量)                                               │
│   ────────────────                                             │
│                                                                 │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │  Token计费 (仅专业版超额、企业版自定义模型)               │   │
│   │  - GPT-4o: $5/$15 per 1M tokens                         │   │
│   │  - Claude 3.5: $3/$15 per 1M tokens                     │   │
│   │  - 国产模型: 按实际定价                                    │   │
│   ├─────────────────────────────────────────────────────────┤   │
│   │  存储超额 (所有套餐)                                       │   │
│   │  - 超出配额: ¥0.1/GB/月                                  │   │
│   ├─────────────────────────────────────────────────────────┤   │
│   │  额外配额包 (可选购买)                                     │   │
│   │  - AI数量扩展: ¥10/AI/月                                 │   │
│   │  - Token包: ¥20/500K tokens                              │   │
│   │  - 存储包: ¥10/10GB/月                                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   企业定制 (协商)                                               │
│   ────────────────                                             │
│                                                                 │
│   - 私有化部署费用                                              │
│   - 定制开发费用                                                │
│   - 专属技术支持                                                │
│   - SLA保障费用                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 计费模型

```typescript
// 计费配置
interface BillingConfig {
  accountId: string;

  // 订阅信息
  subscription: {
    planId: string;
    status: 'active' | 'cancelled' | 'past_due' | 'trialing';
    currentPeriodStart: Date;
    currentPeriodEnd: Date;
    cancelAtPeriodEnd: boolean;
  };

  // 用量计费设置
  usageBilling: {
    enabled: boolean;
    threshold: number;      // 账单阈值，达到后出账
    autoCharge: boolean;    // 自动扣费
    paymentMethod: string;  // 支付方式ID
  };

  // 发票设置
  invoice: {
    email: string;
    taxId?: string;
    address?: string;
  };
}

// 账单
interface Invoice {
  id: string;
  accountId: string;

  // 账单周期
  period: {
    start: Date;
    end: Date;
  };

  // 费用明细
  items: Array<{
    type: 'subscription' | 'usage' | 'overage' | 'addon';
    description: string;
    quantity: number;
    unitPrice: number;
    amount: number;
  }>;

  // 汇总
  summary: {
    subtotal: number;
    tax: number;
    discount: number;
    total: number;
    currency: 'CNY' | 'USD';
  };

  // 状态
  status: 'draft' | 'open' | 'paid' | 'uncollectible' | 'void';
  paidAt?: Date;
}
```

### 5.3 支付方式

```typescript
// 支付提供商
interface PaymentProvider {
  id: string;
  name: string;
  enabled: boolean;

  // 支持的支付方式
  methods: Array<{
    type: 'credit_card' | 'alipay' | 'wechat_pay' | 'bank_transfer';
    enabled: boolean;
    config: Record<string, unknown>;
  }>;
}

// 支付方式配置
const PAYMENT_METHODS = {
  // 国内支付
  domestic: [
    {
      id: 'alipay',
      name: '支付宝',
      type: 'online',
      currencies: ['CNY'],
      recurring: true,      // 支持自动续费
    },
    {
      id: 'wechat_pay',
      name: '微信支付',
      type: 'online',
      currencies: ['CNY'],
      recurring: false,     // 暂不支持自动续费
    },
    {
      id: 'unionpay',
      name: '银联支付',
      type: 'card',
      currencies: ['CNY'],
      recurring: true,
    },
  ],

  // 国际支付
  international: [
    {
      id: 'stripe',
      name: '信用卡/借记卡',
      type: 'card',
      currencies: ['USD', 'EUR', 'GBP'],
      recurring: true,
    },
    {
      id: 'paypal',
      name: 'PayPal',
      type: 'wallet',
      currencies: ['USD', 'EUR', 'GBP'],
      recurring: true,
    },
  ],

  // 企业支付
  enterprise: [
    {
      id: 'bank_transfer',
      name: '银行转账',
      type: 'offline',
      currencies: ['CNY', 'USD'],
      recurring: false,
      minAmount: 1000,      // 最低金额
    },
    {
      id: 'invoice',
      name: '对公转账',
      type: 'offline',
      currencies: ['CNY'],
      recurring: false,
      minAmount: 5000,
    },
  ],
};
```

### 5.4 计费流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     计费流程                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   订阅计费                                                      │
│   ───────────                                                  │
│                                                                 │
│   1. 订阅创建/续费                                               │
│      - 用户选择套餐                                              │
│      - 选择支付方式                                              │
│      - 首次付费立即扣款                                          │
│                                                                 │
│   2. 周期计费                                                    │
│      - 每月/每年固定日期出账                                     │
│      - 自动从绑定支付方式扣款                                    │
│      - 扣款失败进入宽限期 (3天)                                  │
│      - 宽限期结束暂停服务                                        │
│                                                                 │
│   3. 变更计费                                                    │
│      - 升级: 立即生效，按比例补差价                              │
│      - 降级: 当前周期结束生效                                    │
│      - 取消: 当前周期结束停止服务                                │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   用量计费                                                      │
│   ───────────                                                  │
│                                                                 │
│   1. 实时计量                                                    │
│      - 每次API调用记录用量                                       │
│      - 实时更新累计用量                                          │
│      - 接近限额发送预警                                          │
│                                                                 │
│   2. 超额计费 (专业版)                                           │
│      - 超出套餐包含额度                                          │
│      - 按实际用量计费                                            │
│      - 月末统一结算或实时预扣                                    │
│                                                                 │
│   3. 结算出账                                                    │
│      - 达到账单阈值或月末出账                                    │
│      - 生成详细用量账单                                          │
│      - 从绑定支付方式扣款                                        │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   退款处理                                                      │
│   ───────────                                                  │
│                                                                 │
│   1. 订阅退款                                                    │
│      - 7天内无理由退款                                           │
│      - 按比例退还未使用时长                                      │
│      - 原路退回支付账户                                          │
│                                                                 │
│   2. 用量争议                                                    │
│      - 用户可提交用量核查申请                                    │
│      - 技术团队核实用量记录                                      │
│      - 确认异常则退还差额                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 账号打通系统

### 6.1 OpenClaw账号关联

```typescript
// OpenClaw账号关联
interface OpenClawLink {
  id: string;
  accountId: string;          // 小傻瓜账号ID

  // OpenClaw账号信息
  openclaw: {
    userId: string;           // OpenClaw用户ID
    username: string;
    email: string;
    apiKey: string;           // 加密存储
  };

  // 关联状态
  status: 'linked' | 'pending' | 'disconnected';
  linkedAt: Date;
  lastSyncAt?: Date;

  // 同步配置
  sync: {
    agents: boolean;          // 同步AI代理
    channels: boolean;        // 同步通道
    skills: boolean;          // 同步Skills
    settings: boolean;        // 同步设置
    autoSync: boolean;        // 自动同步
    syncInterval: number;     // 同步间隔(分钟)
  };
}
```

### 6.2 数据同步

#### 6.2.1 同步数据类型

```typescript
// 同步数据定义
interface SyncData {
  // AI代理同步
  agents: {
    action: 'create' | 'update' | 'delete';
    data: {
      id: string;
      name: string;
      identity: AgentIdentity;
      model: ModelConfig;
      capabilities: AgentCapabilities;
    };
  }[];

  // 通道同步
  channels: {
    action: 'create' | 'update' | 'delete';
    data: {
      id: string;
      type: 'openclaw' | 'custom';
      name: string;
      config: ChannelConfig;
    };
  }[];

  // Skills同步
  skills: {
    action: 'install' | 'update' | 'uninstall';
    data: {
      id: string;
      version: string;
      config: SkillConfig;
    };
  }[];

  // 设置同步
  settings: {
    section: string;
    key: string;
    value: unknown;
  }[];
}
```

#### 6.2.2 同步流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     数据同步流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   初始同步 (首次关联)                                            │
│   ───────────────────                                          │
│                                                                 │
│   用户授权关联OpenClaw账号                                       │
│        │                                                        │
│        ▼                                                        │
│   获取OpenClaw账号数据                                           │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ - AI代理列表                                             │   │
│   │ - 通道配置                                               │   │
│   │ - 已安装Skills                                           │   │
│   │ - 用户设置                                               │   │
│   └─────────────────────────────────────────────────────────┘   │
│        │                                                        │
│        ▼                                                        │
│   数据映射转换                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │ OpenClaw Agent ──► 小傻瓜 AI代理                         │   │
│   │ OpenClaw Channel ──► 小傻瓜 Channel (OpenClaw类型)       │   │
│   │ OpenClaw Skills ──► 小傻瓜 Skills                        │   │
│   └─────────────────────────────────────────────────────────┘   │
│        │                                                        │
│        ▼                                                        │
│   导入到小傻瓜账号                                               │
│        │                                                        │
│        ├── 成功 ──► 标记同步完成，启用自动同步                   │
│        │                                                        │
│        └── 失败 ──► 记录错误，提供手动重试                       │
│                                                                 │
│   ─────────────────────────────────────                        │
│                                                                 │
│   增量同步 (自动/手动)                                           │
│   ───────────────────                                          │
│                                                                 │
│   触发条件:                                                      │
│   - 定时自动同步 (默认30分钟)                                    │
│   - 用户手动触发                                                 │
│   - OpenClaw数据变更Webhook                                      │
│        │                                                        │
│        ▼                                                        │
│   获取变更数据 (since lastSyncAt)                                │
│        │                                                        │
│        ▼                                                        │
│   冲突检测                                                       │
│        │                                                        │
│        ├── 无冲突 ──► 直接应用变更                               │
│        │                                                        │
│        └── 有冲突 ──► 根据冲突策略处理                           │
│             │                                                   │
│             ├── 小傻瓜优先 ──► 保留本地，标记远程差异            │
│             │                                                   │
│             ├── OpenClaw优先 ──► 应用远程变更                    │
│             │                                                   │
│             └── 手动解决 ──► 提示用户选择                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 6.3 配置导入

#### 6.3.1 导入配置定义

```typescript
// 配置导入
interface ConfigImport {
  // 导入来源
  source: {
    type: 'openclaw' | 'file' | 'url';
    openclawAccount?: string;   // OpenClaw账号ID
    filePath?: string;          // 本地文件路径
    url?: string;               // 远程URL
  };

  // 导入选项
  options: {
    agents: {
      enabled: boolean;
      overwrite: boolean;       // 是否覆盖现有
      prefix?: string;          // 名称前缀
    };
    channels: {
      enabled: boolean;
      overwrite: boolean;
      testConnection: boolean;  // 导入后测试连接
    };
    skills: {
      enabled: boolean;
      overwrite: boolean;
      autoInstall: boolean;     // 自动安装依赖
    };
    settings: {
      enabled: boolean;
      overwrite: boolean;
      sections?: string[];      // 指定导入的设置项
    };
  };

  // 导入结果
  result: {
    status: 'success' | 'partial' | 'failed';
    imported: {
      agents: number;
      channels: number;
      skills: number;
      settings: number;
    };
    errors: Array<{
      type: string;
      item: string;
      message: string;
    }>;
  };
}
```

#### 6.3.2 配置导入API

```typescript
// 从OpenClaw导入配置
interface ImportFromOpenClawAPI {
  // 请求
  request: {
    openclawAccountId: string;
    options: ConfigImport['options'];
  };

  // 响应
  response: {
    jobId: string;              // 异步任务ID
    status: 'queued' | 'processing' | 'completed' | 'failed';
    progress?: number;          // 进度百分比
    result?: ConfigImport['result'];
  };
}

// 查询导入进度
interface GetImportProgressAPI {
  request: {
    jobId: string;
  };
  response: {
    status: 'queued' | 'processing' | 'completed' | 'failed';
    progress: number;
    currentStep: string;
    result?: ConfigImport['result'];
    error?: string;
  };
}
```

---

## 7. 数据库设计

### 7.1 核心表结构

```sql
-- 账号表
CREATE TABLE accounts (
    id VARCHAR(36) PRIMARY KEY,
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    avatar_url TEXT,

    -- 当前套餐
    plan_id VARCHAR(20) NOT NULL DEFAULT 'free',
    plan_status VARCHAR(20) NOT NULL DEFAULT 'active',
    plan_started_at TIMESTAMP,
    plan_expires_at TIMESTAMP,

    -- 配额
    max_agents INT NOT NULL DEFAULT 1,
    max_channels INT NOT NULL DEFAULT 1,
    monthly_tokens BIGINT NOT NULL DEFAULT 100000,
    storage_quota BIGINT NOT NULL DEFAULT 104857600,  -- 100MB

    -- OpenClaw关联
    openclaw_user_id VARCHAR(36),
    openclaw_linked_at TIMESTAMP,

    -- 状态
    status VARCHAR(20) NOT NULL DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_plan_id (plan_id),
    INDEX idx_openclaw_user_id (openclaw_user_id),
    INDEX idx_status (status)
);

-- 套餐定义表
CREATE TABLE plans (
    id VARCHAR(20) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    description TEXT,

    -- 配额限制
    max_agents INT NOT NULL,
    max_channels INT NOT NULL,
    allow_mixed_mode BOOLEAN DEFAULT FALSE,
    monthly_tokens BIGINT NOT NULL,
    storage_quota BIGINT NOT NULL,

    -- 功能开关
    features JSON NOT NULL,

    -- 价格
    monthly_price DECIMAL(10, 2) NOT NULL,
    yearly_price DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',

    -- 状态
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- AI代理表
CREATE TABLE agents (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'assistant',

    -- 模型配置
    model_provider VARCHAR(50),
    model_id VARCHAR(100),
    model_options JSON,

    -- 身份信息
    identity JSON,
    capabilities JSON,

    -- 关联Channel
    channel_id VARCHAR(36),

    -- 用量统计
    tokens_used BIGINT DEFAULT 0,
    requests_made INT DEFAULT 0,

    -- 状态
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_account_id (account_id),
    INDEX idx_channel_id (channel_id),
    INDEX idx_status (status)
);

-- Channel表
CREATE TABLE channels (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    type VARCHAR(20) NOT NULL,  -- 'openclaw', 'platform'
    name VARCHAR(100) NOT NULL,

    -- 配置 (加密存储敏感信息)
    config JSON NOT NULL,

    -- 能力
    capabilities JSON,

    -- 状态
    status VARCHAR(20) DEFAULT 'disconnected',
    last_connected_at TIMESTAMP,

    -- 用量
    tokens_used BIGINT DEFAULT 0,
    requests_made INT DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_account_id (account_id),
    INDEX idx_type (type),
    INDEX idx_status (status)
);

-- 用量记录表 (按小时汇总)
CREATE TABLE usage_records (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    agent_id VARCHAR(36),
    channel_id VARCHAR(36),

    -- 时间
    record_hour TIMESTAMP NOT NULL,  -- 按小时汇总

    -- Token用量
    tokens_input BIGINT DEFAULT 0,
    tokens_output BIGINT DEFAULT 0,
    tokens_total BIGINT DEFAULT 0,

    -- 请求统计
    requests_total INT DEFAULT 0,
    requests_success INT DEFAULT 0,
    requests_failed INT DEFAULT 0,

    -- 费用
    cost DECIMAL(10, 6) DEFAULT 0,
    currency VARCHAR(3) DEFAULT 'USD',

    -- 模型信息
    model_provider VARCHAR(50),
    model_id VARCHAR(100),

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_account_hour (account_id, record_hour),
    INDEX idx_agent_hour (agent_id, record_hour),
    INDEX idx_channel_hour (channel_id, record_hour)
);

-- 订阅记录表
CREATE TABLE subscriptions (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    plan_id VARCHAR(20) NOT NULL,

    -- 周期
    period_start TIMESTAMP NOT NULL,
    period_end TIMESTAMP NOT NULL,

    -- 支付
    amount DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    payment_method VARCHAR(50),
    payment_status VARCHAR(20) NOT NULL,
    paid_at TIMESTAMP,

    -- 状态
    status VARCHAR(20) NOT NULL,  -- 'active', 'cancelled', 'expired'
    cancelled_at TIMESTAMP,
    cancel_reason TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_account_id (account_id),
    INDEX idx_period (period_start, period_end),
    INDEX idx_status (status)
);

-- 账单表
CREATE TABLE invoices (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL,
    subscription_id VARCHAR(36),

    -- 周期
    period_start TIMESTAMP,
    period_end TIMESTAMP,

    -- 金额
    subtotal DECIMAL(10, 2) NOT NULL,
    tax DECIMAL(10, 2) DEFAULT 0,
    discount DECIMAL(10, 2) DEFAULT 0,
    total DECIMAL(10, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,

    -- 明细
    items JSON NOT NULL,

    -- 状态
    status VARCHAR(20) NOT NULL,  -- 'draft', 'open', 'paid', 'void'
    due_date TIMESTAMP,
    paid_at TIMESTAMP,

    -- 发票
    invoice_number VARCHAR(50),
    invoice_url TEXT,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_account_id (account_id),
    INDEX idx_status (status),
    INDEX idx_due_date (due_date)
);

-- OpenClaw关联表
CREATE TABLE openclaw_links (
    id VARCHAR(36) PRIMARY KEY,
    account_id VARCHAR(36) NOT NULL UNIQUE,

    -- OpenClaw信息
    openclaw_user_id VARCHAR(36) NOT NULL,
    openclaw_username VARCHAR(100),
    openclaw_email VARCHAR(255),
    openclaw_api_key_encrypted TEXT,  -- 加密存储

    -- 同步配置
    sync_config JSON,

    -- 状态
    status VARCHAR(20) DEFAULT 'linked',
    linked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_sync_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (account_id) REFERENCES accounts(id),
    INDEX idx_openclaw_user_id (openclaw_user_id),
    INDEX idx_status (status)
);
```

### 7.2 初始化数据

```sql
-- 初始化套餐
INSERT INTO plans (
    id, name, description,
    max_agents, max_channels, allow_mixed_mode,
    monthly_tokens, storage_quota,
    features,
    monthly_price, yearly_price, currency
) VALUES
(
    'free', '基础版', '个人用户入门选择',
    1, 1, FALSE,
    100000, 104857600,
    '{"skills": "basic", "cloudSync": "basic", "api": false, "team": false}',
    0, 0, 'CNY'
),
(
    'pro', '专业版', '个人专业用户和中小团队',
    5, 5, TRUE,
    1000000, 10737418240,
    '{"skills": "full", "cloudSync": "full", "api": "readonly", "team": 5}',
    29, 290, 'CNY'
),
(
    'enterprise', '企业版', '大型团队和企业用户',
    -1, -1, TRUE,
    -1, -1,
    '{"skills": "custom", "cloudSync": "private", "api": "full", "team": -1, "sso": true, "audit": true}',
    199, 1990, 'CNY'
);
```

---

## 8. API接口设计

### 8.1 账号管理API

```typescript
// 获取当前账号信息
GET /api/v1/account
Response: {
  id: string;
  email: string;
  name: string;
  avatar: string;
  plan: {
    id: string;
    name: string;
    status: string;
    expiresAt: Date;
  };
  quota: {
    agents: { used: number; total: number; };
    channels: { used: number; total: number; };
    tokens: { used: number; total: number; resetAt: Date; };
    storage: { used: number; total: number; };
  };
}

// 获取可用套餐
GET /api/v1/plans
Response: Plan[]

// 升级/降级套餐
POST /api/v1/account/upgrade
Body: {
  planId: string;
  period: 'monthly' | 'yearly';
  paymentMethodId?: string;
}
Response: {
  orderId: string;
  amount: number;
  currency: string;
  paymentUrl?: string;  // 需要额外支付时
}

// 取消订阅
POST /api/v1/account/cancel
Body: {
  reason?: string;
  immediate: boolean;  // 是否立即生效
}
```

### 8.2 AI配额管理API

```typescript
// 获取配额详情
GET /api/v1/quota
Response: AccountQuota

// 获取用量统计
GET /api/v1/usage
Query: {
  startDate: string;
  endDate: string;
  granularity: 'hour' | 'day' | 'week' | 'month';
}
Response: UsageMetrics

// 购买额外配额包
POST /api/v1/quota/addon
Body: {
  type: 'agents' | 'tokens' | 'storage';
  quantity: number;
  period: 'monthly' | 'one_time';
}
```

### 8.3 Channel管理API

```typescript
// 获取Channel列表
GET /api/v1/channels
Response: Channel[]

// 添加OpenClaw Channel
POST /api/v1/channels/openclaw
Body: {
  name: string;
  deviceId: string;
  apiKey: string;
  wsUrl: string;
}
Response: Channel

// 添加平台Channel
POST /api/v1/channels/platform
Body: {
  name: string;
  provider: string;
  modelId: string;
  options?: ModelOptions;
}
Response: Channel

// 更新Channel
PUT /api/v1/channels/:id
Body: Partial<Channel>
Response: Channel

// 删除Channel
DELETE /api/v1/channels/:id
Response: { success: boolean }

// 测试Channel连接
POST /api/v1/channels/:id/test
Response: {
  success: boolean;
  latency: number;
  error?: string;
}
```

### 8.4 OpenClaw关联API

```typescript
// 关联OpenClaw账号
POST /api/v1/openclaw/link
Body: {
  apiKey: string;
  syncOptions: {
    agents: boolean;
    channels: boolean;
    skills: boolean;
    settings: boolean;
  };
}
Response: {
  success: boolean;
  openclawUser: {
    id: string;
    username: string;
    email: string;
  };
  importJobId?: string;
}

// 解除关联
DELETE /api/v1/openclaw/link
Response: { success: boolean }

// 获取同步状态
GET /api/v1/openclaw/sync
Response: {
  status: 'idle' | 'syncing' | 'error';
  lastSyncAt: Date;
  nextSyncAt: Date;
  progress?: number;
}

// 手动触发同步
POST /api/v1/openclaw/sync
Body: {
  fullSync: boolean;  // 是否全量同步
}
Response: {
  jobId: string;
}

// 导入配置
POST /api/v1/openclaw/import
Body: {
  options: ConfigImport['options'];
}
Response: {
  jobId: string;
}
```

### 8.5 计费API

```typescript
// 获取账单列表
GET /api/v1/billing/invoices
Query: {
  status?: string;
  from?: string;
  to?: string;
}
Response: Invoice[]

// 获取账单详情
GET /api/v1/billing/invoices/:id
Response: Invoice

// 获取支付方式
GET /api/v1/billing/payment-methods
Response: PaymentMethod[]

// 添加支付方式
POST /api/v1/billing/payment-methods
Body: {
  type: string;
  // 根据类型不同，参数不同
}
Response: PaymentMethod

// 设置默认支付方式
PUT /api/v1/billing/payment-methods/:id/default
Response: { success: boolean }

// 删除支付方式
DELETE /api/v1/billing/payment-methods/:id
Response: { success: boolean }

// 获取用量预估
GET /api/v1/billing/estimate
Response: {
  currentMonth: {
    subscription: number;
    usage: number;
    projected: number;
  };
}
```

---

## 9. 前端界面设计

### 9.1 账号管理页面

```
┌─────────────────────────────────────────────────────────────────┐
│  账号设置                                    [保存] [取消]       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  当前套餐: 专业版 (Pro)                              [升级]      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  到期时间: 2026-03-23                                   │   │
│  │  自动续费: 已开启                              [管理]    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  AI配额                                                        │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  已使用: 3/5 AI                                         │   │
│  │  ████████████████████░░░░░░░░░░  60%                   │   │
│  │                                                         │   │
│  │  Token用量 (本月): 650K/1M                              │   │
│  │  ████████████████████████░░░░░░  65%                   │   │
│  │  重置时间: 7天后                                         │   │
│  │                                                         │   │
│  │  存储空间: 2.3GB/10GB                                   │   │
│  │  ████████░░░░░░░░░░░░░░░░░░░░░░  23%                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [购买额外配额]                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 Channel管理页面

```
┌─────────────────────────────────────────────────────────────────┐
│  Channel管理                               [+ 添加Channel]       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  OpenClaw设备 (2/5)                                            │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [图标] 我的OpenClaw-1                    [编辑] [删除]  │   │
│  │  设备ID: device_001    状态: ● 已连接                    │   │
│  │  关联AI: 小助手, 工作伙伴                                │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [图标] 办公室设备                        [编辑] [删除]  │   │
│  │  设备ID: device_002    状态: ● 已连接                    │   │
│  │  关联AI: 技术支持                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  平台模型 (1/5)                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [图标] GPT-4o助手                        [编辑] [删除]  │   │
│  │  提供商: OpenAI    模型: GPT-4o                         │   │
│  │  本月用量: 125K tokens    费用: $0.25                   │   │
│  │  关联AI: 创意助手                                        │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 9.3 OpenClaw关联页面

```
┌─────────────────────────────────────────────────────────────────┐
│  OpenClaw账号关联                                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  关联状态: ● 已关联                                             │
│                                                                 │
│  关联账号信息                                                   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  用户名: sillychat_user                                │   │
│  │  邮箱: user@example.com                                 │   │
│  │  关联时间: 2026-01-15                                   │   │
│  │  最后同步: 2小时前                                       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  同步设置                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  [✓] 自动同步AI代理                                      │   │
│  │  [✓] 自动同步通道配置                                    │   │
│  │  [ ] 自动同步Skills                                      │   │
│  │  [ ] 自动同步设置                                        │   │
│  │                                                         │   │
│  │  同步频率: [每30分钟 ▼]                                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  [立即同步]  [导入配置]  [解除关联]                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 10. 安全与合规

### 10.1 数据安全

```typescript
interface SecurityConfig {
  // API密钥加密
  apiKeyEncryption: {
    algorithm: 'AES-256-GCM';
    keyRotation: boolean;
    rotationInterval: number;  // 天
  };

  // 敏感数据脱敏
  dataMasking: {
    apiKey: {
      display: 'show_last_4';  // 显示后4位
      storage: 'encrypted';
    };
    email: {
      display: 'mask_local_part';  // 显示部分
    };
  };

  // 访问控制
  accessControl: {
    rateLimit: {
      window: 60000;      // 1分钟
      maxRequests: 100;   // 最大请求数
    };
    ipWhitelist?: string[];
    mfaRequired: boolean;
  };
}
```

### 10.2 合规要求

| 合规项 | 要求 | 实现方式 |
|--------|------|----------|
| 数据隐私 | GDPR/CCPA合规 | 数据加密、用户数据导出/删除 |
| 支付安全 | PCI DSS | 使用合规支付提供商，不存储卡号 |
| 财务合规 | 发票管理 | 自动生成符合税务要求的发票 |
| 审计日志 | 操作可追溯 | 记录所有关键操作日志 |

---

## 11. 部署与运维

### 11.1 服务架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     付费系统服务架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│   │   API服务    │  │  计费服务   │  │  同步服务   │            │
│   │  (REST API) │  │  (Billing)  │  │  (Sync)     │            │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘            │
│          │                │                │                    │
│          └────────────────┼────────────────┘                    │
│                           │                                     │
│                  ┌────────▼────────┐                           │
│                  │   消息队列       │                           │
│                  │  (Redis/Rabbit) │                           │
│                  └────────┬────────┘                           │
│                           │                                     │
│   ┌───────────────────────┼───────────────────────┐            │
│   │                       │                       │            │
│   ▼                       ▼                       ▼            │
│ ┌──────────┐        ┌──────────┐        ┌──────────┐          │
│ │  MySQL   │        │  Redis   │        │ 对象存储  │          │
│ │ (主数据) │        │ (缓存)   │        │ (文件)   │          │
│ └──────────┘        └──────────┘        └──────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 11.2 监控指标

```typescript
interface MonitoringMetrics {
  // 业务指标
  business: {
    dailyActiveUsers: number;
    newSubscriptions: number;
    churnRate: number;
    mrr: number;            // 月度经常性收入
    arr: number;            // 年度经常性收入
  };

  // 技术指标
  technical: {
    apiResponseTime: number;
    errorRate: number;
    paymentSuccessRate: number;
    syncSuccessRate: number;
  };

  // 告警阈值
  alerts: {
    paymentFailureRate: '> 5%';
    apiErrorRate: '> 1%';
    quotaExhaustionRate: '> 20%';
  };
}
```

---

## 12. 附录

### 12.1 术语表

| 术语 | 英文 | 说明 |
|------|------|------|
| 账号类型 | Plan | 用户订阅的套餐等级 |
| AI配额 | AI Quota | 账号可配置的AI代理数量上限 |
| Channel | Channel | 模型接入通道，包括OpenClaw设备和平台模型 |
| Token | Token | AI模型的计费单位 |
| MRR | Monthly Recurring Revenue | 月度经常性收入 |

### 12.2 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2026-02-23 | 初始版本 |

---

*文档版本: 1.0*
*创建日期: 2026-02-23*
*最后更新: 2026-02-23*
