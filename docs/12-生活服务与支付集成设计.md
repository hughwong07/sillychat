# ç”Ÿæ´»æœåŠ¡ä¸æ”¯ä»˜é›†æˆè®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° SillyChat çš„ç”Ÿæ´»æœåŠ¡ä¸æ”¯ä»˜é›†æˆè®¾è®¡ï¼Œå®ç°AIé©±åŠ¨çš„æ™ºèƒ½ç”Ÿæ´»æœåŠ¡å…¥å£ï¼Œé›†æˆå¤šæ¸ é“æ”¯ä»˜èƒ½åŠ›ï¼Œæ‰“é€ ä¾¿æ·çš„ç”Ÿæ´»æœåŠ¡ä½“éªŒã€‚

---

## 1. ç”Ÿæ´»æœåŠ¡åœºæ™¯åˆ†æ

### 1.1 æœåŠ¡åˆ†ç±»çŸ©é˜µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”Ÿæ´»æœåŠ¡åœºæ™¯çŸ©é˜µ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     æ—¥å¸¸ç¼´è´¹      â”‚     å‡ºè¡ŒæœåŠ¡      â”‚     é¤é¥®æœåŠ¡      â”‚     è´­ç‰©æ¶ˆè´¹       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ°´è´¹ç¼´çº³        â”‚ â€¢ ç½‘çº¦è½¦         â”‚ â€¢ å¤–å–ç‚¹é¤        â”‚ â€¢ ç”µå•†è´­ç‰©        â”‚
â”‚ â€¢ ç”µè´¹ç¼´çº³        â”‚ â€¢ ç«è½¦ç¥¨         â”‚ â€¢ é¤å…é¢„è®¢        â”‚ â€¢ è¶…å¸‚é…é€        â”‚
â”‚ â€¢ ç‡ƒæ°”è´¹ç¼´çº³      â”‚ â€¢ é£æœºç¥¨         â”‚ â€¢ æ’é˜Ÿå–å·        â”‚ â€¢ ä¾¿åˆ©åº—          â”‚
â”‚ â€¢ è¯è´¹å……å€¼        â”‚ â€¢ é…’åº—é¢„è®¢        â”‚ â€¢ å›¢è´­ä¼˜æƒ         â”‚ â€¢ ç”Ÿé²œé…é€        â”‚
â”‚ â€¢ å®½å¸¦ç¼´è´¹        â”‚ â€¢ å…±äº«å•è½¦        â”‚ â€¢ ç‚¹é¤åŠ©æ‰‹        â”‚ â€¢ è¯å“è´­ä¹°        â”‚
â”‚ â€¢ ç‰©ä¸šè´¹         â”‚ â€¢ åœè½¦ç¼´è´¹        â”‚ â€¢ é£Ÿè°±æ¨è        â”‚ â€¢ äºŒæ‰‹äº¤æ˜“        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     åŒ»ç–—å¥åº·      â”‚     é‡‘èæœåŠ¡      â”‚     å¨±ä¹ä¼‘é—²      â”‚     æ”¿åŠ¡æœåŠ¡       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ åŒ»é™¢æŒ‚å·        â”‚ â€¢ è½¬è´¦æ±‡æ¬¾        â”‚ â€¢ ç”µå½±ç¥¨åŠ¡        â”‚ â€¢ ç¤¾ä¿æŸ¥è¯¢        â”‚
â”‚ â€¢ åœ¨çº¿é—®è¯Š        â”‚ â€¢ ä¿¡ç”¨å¡è¿˜æ¬¾      â”‚ â€¢ æ¼”å‡ºç¥¨åŠ¡        â”‚ â€¢ å…¬ç§¯é‡‘æŸ¥è¯¢      â”‚
â”‚ â€¢ ä½“æ£€é¢„çº¦        â”‚ â€¢ ç†è´¢è´­ä¹°        â”‚ â€¢ æ™¯ç‚¹é—¨ç¥¨        â”‚ â€¢ è¿ç« æŸ¥è¯¢        â”‚
â”‚ â€¢ è¯å“é…é€        â”‚ â€¢ ä¿é™©è´­ä¹°        â”‚ â€¢ æ¸¸æˆå……å€¼        â”‚ â€¢ è¯ä»¶åŠç†        â”‚
â”‚ â€¢ ç–«è‹—é¢„çº¦        â”‚ â€¢ è´·æ¬¾ç”³è¯·        â”‚ â€¢ ä¼šå‘˜å……å€¼        â”‚ â€¢ ç¨åŠ¡ç”³æŠ¥        â”‚
â”‚ â€¢ å¥åº·æ¡£æ¡ˆ        â”‚ â€¢ è‚¡ç¥¨äº¤æ˜“        â”‚ â€¢ ç›´æ’­æ‰“èµ        â”‚ â€¢ é¢„çº¦åŠäº‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ç”¨æˆ·åœºæ™¯ç”¨ä¾‹

```typescript
// åœºæ™¯1ï¼šæ™ºèƒ½ç¼´è´¹æé†’
interface SmartPaymentScenario {
  trigger: 'bill_due' | 'low_balance' | 'schedule';
  aiAction: {
    analyze: 'æŸ¥è¯¢è´¦å•å†å²';
    predict: 'é¢„æµ‹æœ€ä½³ç¼´è´¹æ—¶é—´';
    recommend: 'æ¨èä¼˜æƒ æ¸ é“';
    execute: 'ä¸€é”®å®Œæˆç¼´è´¹';
  };
}

// åœºæ™¯2ï¼šå‡ºè¡Œæ™ºèƒ½è§„åˆ’
interface TravelPlanningScenario {
  userRequest: 'ä¸‹å‘¨å»ä¸Šæµ·å‡ºå·®3å¤©';
  aiAction: {
    search: 'æŸ¥è¯¢èˆªç­/é«˜é“';
    compare: 'æ¯”ä»·æ—¶é—´/ä»·æ ¼';
    book: 'é¢„è®¢æœºç¥¨+é…’åº—';
    schedule: 'æ·»åŠ åˆ°æ—¥å†';
    prepare: 'å‘é€è¡Œç¨‹æé†’';
  };
}

// åœºæ™¯3ï¼šé¤é¥®æ™ºèƒ½åŠ©æ‰‹
interface DiningAssistantScenario {
  userRequest: 'é™„è¿‘æœ‰ä»€ä¹ˆå¥½åƒçš„';
  aiAction: {
    locate: 'è·å–å½“å‰ä½ç½®';
    recommend: 'åŸºäºåå¥½æ¨è';
    check: 'æŸ¥è¯¢æ’é˜Ÿæƒ…å†µ';
    reserve: 'é¢„çº¦æˆ–æ’é˜Ÿ';
    navigate: 'æä¾›å¯¼èˆª';
  };
}
```

---

## 2. æ”¯ä»˜èƒ½åŠ›æ¶æ„

### 2.1 æ”¯ä»˜æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ”¯ä»˜èƒ½åŠ›æ¶æ„                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          åº”ç”¨å±‚ (Application Layer)                      â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚ æ”¯ä»˜ç¡®è®¤ç•Œé¢ â”‚  â”‚ è´¦å•ç®¡ç†   â”‚  â”‚ äº¤æ˜“è®°å½•   â”‚  â”‚ ä¼˜æƒ åˆ¸/çº¢åŒ…     â”‚ â”‚â”‚
â”‚  â”‚  â”‚ (UIç»„ä»¶)    â”‚  â”‚           â”‚  â”‚           â”‚  â”‚                â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚â”‚
â”‚  â”‚                          â”‚                                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â–¼                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          æ ¸å¿ƒæ”¯ä»˜å±‚ (Core Payment)                       â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚                      æ”¯ä»˜ç¼–æ’å™¨ (Payment Orchestrator)             â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚ è·¯ç”±å†³ç­–  â”‚  â”‚ é£æ§æ£€æŸ¥  â”‚  â”‚ é™é¢ç®¡ç†  â”‚  â”‚ å¯¹è´¦/ç»“ç®—    â”‚   â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â”‚  (Router) â”‚  â”‚  (Risk)   â”‚  â”‚ (Limit)   â”‚  â”‚ (Reconcile)   â”‚   â”‚  â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚â”‚
â”‚  â”‚  â”‚                    æ”¯ä»˜æ¸ é“é€‚é…å±‚ (Channel Adapters)             â”‚    â”‚â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚â”‚
â”‚  â”‚  â”‚  â”‚å¾®ä¿¡æ”¯ä»˜ â”‚ â”‚ æ”¯ä»˜å®  â”‚ â”‚ é“¶è¡Œå¡  â”‚ â”‚æ•°å­—äººæ°‘å¸â”‚ â”‚  Apple   â”‚ â”‚    â”‚â”‚
â”‚  â”‚  â”‚  â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚ Adapter â”‚ â”‚  Pay     â”‚ â”‚    â”‚â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                    â”‚                                        â”‚
â”‚                                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          å®‰å…¨å±‚ (Security Layer)                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚  â”‚  ç”Ÿç‰©è¯†åˆ«    â”‚ â”‚  å¯†é’¥ç®¡ç†    â”‚ â”‚  é£æ§å¼•æ“    â”‚ â”‚   å®‰å…¨æ²™ç®±     â”‚  â”‚â”‚
â”‚  â”‚  â”‚(æŒ‡çº¹/äººè„¸)   â”‚ â”‚  (HSM/TEE)   â”‚ â”‚(å¼‚å¸¸æ£€æµ‹)   â”‚ â”‚ (æ”¯ä»˜éš”ç¦»)     â”‚  â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ”¯ä»˜æµç¨‹çŠ¶æ€æœº

```typescript
// æ”¯ä»˜çŠ¶æ€å®šä¹‰
enum PaymentStatus {
  INITIATED = 'initiated',           // å‘èµ·
  PENDING_CONFIRM = 'pending_confirm', // å¾…ç¡®è®¤
  PROCESSING = 'processing',         // å¤„ç†ä¸­
  AUTH_REQUIRED = 'auth_required',   // éœ€éªŒè¯
  AUTHENTICATING = 'authenticating', // éªŒè¯ä¸­
  RISK_CHECKING = 'risk_checking',   // é£æ§æ£€æŸ¥
  CHANNEL_CALLING = 'channel_calling', // æ¸ é“è°ƒç”¨
  SUCCESS = 'success',               // æˆåŠŸ
  FAILED = 'failed',                 // å¤±è´¥
  CANCELLED = 'cancelled',           // å–æ¶ˆ
  REFUNDING = 'refunding',           // é€€æ¬¾ä¸­
  REFUNDED = 'refunded'              // å·²é€€æ¬¾
}

// æ”¯ä»˜çŠ¶æ€æµè½¬
interface PaymentStateMachine {
  transitions: {
    [PaymentStatus.INITIATED]: [
      PaymentStatus.PENDING_CONFIRM,
      PaymentStatus.CANCELLED
    ];
    [PaymentStatus.PENDING_CONFIRM]: [
      PaymentStatus.PROCESSING,
      PaymentStatus.CANCELLED
    ];
    [PaymentStatus.PROCESSING]: [
      PaymentStatus.AUTH_REQUIRED,
      PaymentStatus.RISK_CHECKING,
      PaymentStatus.CHANNEL_CALLING
    ];
    [PaymentStatus.AUTH_REQUIRED]: [
      PaymentStatus.AUTHENTICATING,
      PaymentStatus.FAILED
    ];
    [PaymentStatus.AUTHENTICATING]: [
      PaymentStatus.CHANNEL_CALLING,
      PaymentStatus.FAILED
    ];
    [PaymentStatus.RISK_CHECKING]: [
      PaymentStatus.CHANNEL_CALLING,
      PaymentStatus.FAILED
    ];
    [PaymentStatus.CHANNEL_CALLING]: [
      PaymentStatus.SUCCESS,
      PaymentStatus.FAILED
    ];
    [PaymentStatus.SUCCESS]: [
      PaymentStatus.REFUNDING
    ];
    [PaymentStatus.FAILED]: [
      PaymentStatus.INITIATED  // é‡è¯•
    ];
  };
}
```

---

## 3. å®‰å…¨æ¶æ„è®¾è®¡

### 3.1 å¤šå±‚å®‰å…¨é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ”¯ä»˜å®‰å…¨æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   Layer 5: åº”ç”¨å±‚å®‰å…¨         å®‰å…¨é”®ç›˜ / é˜²æˆªå± / é˜²å½•å± / ä»£ç æ··æ·†            â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Layer 4: è®¤è¯å±‚å®‰å…¨         ç”Ÿç‰©è¯†åˆ« / æ”¯ä»˜å¯†ç  / è®¾å¤‡ç»‘å®š / å¤šå› ç´ è®¤è¯      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Layer 3: äº¤æ˜“å±‚å®‰å…¨         é™é¢ç®¡ç† / é£æ§å¼•æ“ / å¼‚å¸¸æ£€æµ‹ / äº¤æ˜“ç­¾å        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Layer 2: ä¼ è¾“å±‚å®‰å…¨         TLS 1.3 / è¯ä¹¦å›ºå®š / åŒå‘è®¤è¯ / é˜²ä¸­é—´äºº        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Layer 1: å­˜å‚¨å±‚å®‰å…¨         TEE/SE / å¯†é’¥åˆ†å‰² / åŠ å¯†å­˜å‚¨ / å®‰å…¨æ“¦é™¤         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å¯†é’¥ç®¡ç†

```typescript
// src/payment/security/key-management.ts

interface KeyManagementSystem {
  // ä¸»å¯†é’¥å­˜å‚¨åœ¨HSM/TEEä¸­
  masterKey: HSMStoredKey;

  // å¯†é’¥å±‚æ¬¡ç»“æ„
  keyHierarchy: {
    // L1: ä¸»å¯†é’¥ï¼ˆæ°¸ä¸ç¦»å¼€HSMï¼‰
    level1: MasterKey;

    // L2: å¯†é’¥åŠ å¯†å¯†é’¥
    level2: KEK[];

    // L3: æ•°æ®åŠ å¯†å¯†é’¥
    level3: DEK[];

    // L4: ä¼šè¯å¯†é’¥
    level4: SessionKey[];
  };
}

// å¯†é’¥æ´¾ç”Ÿ
class KeyDerivation {
  // ä»ä¸»å¯†é’¥æ´¾ç”Ÿç”¨æˆ·å¯†é’¥
  async deriveUserKey(
    masterKey: MasterKey,
    userId: string,
    deviceId: string
  ): Promise<UserKey> {
    const salt = await this.getOrCreateSalt(userId);

    // HKDFæ´¾ç”Ÿ
    const derived = await hkdf(
      'sha512',
      masterKey,
      salt,
      `${userId}:${deviceId}`,
      32
    );

    return {
      key: derived,
      version: 1,
      createdAt: Date.now()
    };
  }

  // å¯†é’¥è½®æ¢
  async rotateKeys(): Promise<void> {
    // 1. ç”Ÿæˆæ–°å¯†é’¥
    const newKey = await this.generateKey();

    // 2. é‡åŠ å¯†æ•°æ®
    await this.reEncryptData(newKey);

    // 3. æ›´æ–°å¯†é’¥ç‰ˆæœ¬
    await this.updateKeyVersion(newKey);

    // 4. ä½¿æ—§å¯†é’¥è¿‡æœŸ
    await this.expireOldKey();
  }
}
```

### 3.3 ç”Ÿç‰©è¯†åˆ«è®¤è¯

```typescript
// src/payment/security/biometric-auth.ts

interface BiometricAuth {
  // æ”¯æŒçš„ç”Ÿç‰©è¯†åˆ«ç±»å‹
  supportedTypes: ('fingerprint' | 'face' | 'iris' | 'voice')[];

  // è®¤è¯çº§åˆ«
  securityLevel: 'weak' | 'strong' | 'very_strong';
}

class BiometricAuthenticator {
  // æ£€æŸ¥ç”Ÿç‰©è¯†åˆ«å¯ç”¨æ€§
  async checkAvailability(): Promise<BiometricAvailability> {
    const available = await this.probeHardware();
    return {
      fingerprint: available.fingerprint && await this.checkEnrolled('fingerprint'),
      face: available.face && await this.checkEnrolled('face'),
      recommended: available.face ? 'face' : 'fingerprint'
    };
  }

  // ç”Ÿç‰©è¯†åˆ«è®¤è¯
  async authenticate(
    amount: number,
    purpose: string
  ): Promise<AuthResult> {
    // æ ¹æ®é‡‘é¢é€‰æ‹©è®¤è¯å¼ºåº¦
    const config = this.getAuthConfig(amount);

    try {
      const result = await this.promptBiometric({
        title: `æ”¯ä»˜ Â¥${amount}`,
        subtitle: purpose,
        cancelLabel: 'å–æ¶ˆ',
        allowDeviceCredential: false, // ä¸å…è®¸é™çº§ä¸ºè®¾å¤‡å¯†ç 
        confirmationRequired: amount > 1000 // å¤§é¢éœ€äºŒæ¬¡ç¡®è®¤
      });

      if (result.success) {
        // ç­¾åäº¤æ˜“
        const signature = await this.signWithBiometricKey(
          result.cryptoObject,
          this.buildTransactionData()
        );

        return { success: true, signature };
      }

      return { success: false, error: result.error };
    } catch (err) {
      return { success: false, error: err.message };
    }
  }

  // éªŒè¯ç”Ÿç‰©è¯†åˆ«ç­¾å
  async verifySignature(
    signature: Uint8Array,
    publicKey: CryptoKey,
    data: Uint8Array
  ): Promise<boolean> {
    return await crypto.subtle.verify(
      { name: 'ECDSA', hash: 'SHA-256' },
      publicKey,
      signature,
      data
    );
  }
}
```

### 3.4 é£æ§å¼•æ“

```typescript
// src/payment/security/risk-engine.ts

interface RiskEngine {
  // å®æ—¶é£æ§æ£€æŸ¥
  assessTransaction(tx: Transaction): Promise<RiskAssessment>;

  // è§„åˆ™å¼•æ“
  rules: RiskRule[];

  // æœºå™¨å­¦ä¹ æ¨¡å‹
  mlModel: FraudDetectionModel;
}

class RealTimeRiskEngine implements RiskEngine {
  private rules: RiskRule[] = [
    // è§„åˆ™1: å•ç¬”é™é¢
    {
      id: 'single_amount_limit',
      condition: (tx) => tx.amount > this.getUserLimit(tx.userId, 'single'),
      action: 'block',
      message: 'è¶…å‡ºå•ç¬”æ”¯ä»˜é™é¢'
    },

    // è§„åˆ™2: æ—¥ç´¯è®¡é™é¢
    {
      id: 'daily_amount_limit',
      condition: async (tx) => {
        const dailyTotal = await this.getDailyTotal(tx.userId);
        return dailyTotal + tx.amount > this.getUserLimit(tx.userId, 'daily');
      },
      action: 'block',
      message: 'è¶…å‡ºä»Šæ—¥æ”¯ä»˜é™é¢'
    },

    // è§„åˆ™3: å¼‚åœ°ç™»å½•æ£€æµ‹
    {
      id: 'geo_anomaly',
      condition: async (tx) => {
        const lastLocation = await this.getLastLocation(tx.userId);
        const distance = this.calculateDistance(lastLocation, tx.location);
        const timeDiff = tx.timestamp - lastLocation.timestamp;
        // 1å°æ—¶å†…ç§»åŠ¨è¶…è¿‡500km
        return distance > 500 && timeDiff < 3600000;
      },
      action: 'challenge',
      challenge: 'additional_auth',
      message: 'æ£€æµ‹åˆ°å¼‚å¸¸ç™»å½•åœ°ç‚¹'
    },

    // è§„åˆ™4: é«˜é¢‘äº¤æ˜“
    {
      id: 'high_frequency',
      condition: async (tx) => {
        const recentCount = await this.getRecentTransactionCount(tx.userId, 60000);
        return recentCount > 10; // 1åˆ†é’Ÿå†…è¶…è¿‡10ç¬”
      },
      action: 'challenge',
      challenge: 'captcha',
      message: 'äº¤æ˜“è¿‡äºé¢‘ç¹'
    },

    // è§„åˆ™5: é»‘åå•å•†æˆ·
    {
      id: 'blacklist_merchant',
      condition: (tx) => this.blacklist.has(tx.merchantId),
      action: 'block',
      message: 'è¯¥å•†æˆ·å­˜åœ¨é£é™©'
    },

    // è§„åˆ™6: æ–°è®¾å¤‡
    {
      id: 'new_device',
      condition: async (tx) => {
        const isTrusted = await this.isTrustedDevice(tx.userId, tx.deviceId);
        return !isTrusted;
      },
      action: 'challenge',
      challenge: 'sms_otp',
      message: 'åœ¨æ–°è®¾å¤‡ä¸Šç™»å½•'
    }
  ];

  async assessTransaction(tx: Transaction): Promise<RiskAssessment> {
    let score = 0;
    const triggeredRules: RiskRule[] = [];

    // è§„åˆ™å¼•æ“è¯„ä¼°
    for (const rule of this.rules) {
      const triggered = await rule.condition(tx);
      if (triggered) {
        triggeredRules.push(rule);
        score += rule.weight || 10;

        if (rule.action === 'block') {
          return {
            decision: 'block',
            score: 100,
            triggeredRules,
            message: rule.message
          };
        }
      }
    }

    // MLæ¨¡å‹è¯„ä¼°
    const mlScore = await this.mlModel.predict(tx);
    score += mlScore * 20;

    // å†³ç­–
    if (score >= 80) {
      return { decision: 'block', score, triggeredRules };
    } else if (score >= 50) {
      return { decision: 'challenge', score, triggeredRules };
    } else {
      return { decision: 'allow', score, triggeredRules };
    }
  }
}
```

---

## 4. æœåŠ¡å•†æ¥å…¥è§„èŒƒ

### 4.1 ç»Ÿä¸€æ¥å£å±‚

```typescript
// src/payment/services/service-adapter.ts

// ç»Ÿä¸€æœåŠ¡æ¥å£
interface LifeServiceAdapter {
  // æœåŠ¡ä¿¡æ¯
  readonly serviceId: string;
  readonly serviceName: string;
  readonly category: ServiceCategory;
  readonly supportedPayments: PaymentChannel[];

  // æŸ¥è¯¢èƒ½åŠ›
  query(params: QueryParams): Promise<QueryResult>;

  // ä¸‹å•èƒ½åŠ›
  createOrder(order: OrderParams): Promise<OrderResult>;

  // æ”¯ä»˜å›è°ƒ
  handlePaymentCallback(callback: PaymentCallback): Promise<void>;

  // è®¢å•æŸ¥è¯¢
  queryOrder(orderId: string): Promise<OrderStatus>;

  // é€€æ¬¾
  refund(orderId: string, amount: number): Promise<RefundResult>;
}

// æœåŠ¡æ³¨å†Œè¡¨
class ServiceRegistry {
  private adapters: Map<string, LifeServiceAdapter> = new Map();

  register(adapter: LifeServiceAdapter): void {
    this.adapters.set(adapter.serviceId, adapter);
  }

  async routeRequest(
    serviceType: ServiceCategory,
    action: string,
    params: unknown
  ): Promise<unknown> {
    // æ ¹æ®æœåŠ¡ç±»å‹é€‰æ‹©é€‚é…å™¨
    const adapters = this.findAdaptersByCategory(serviceType);

    // è´Ÿè½½å‡è¡¡é€‰æ‹©
    const adapter = this.selectAdapter(adapters);

    // æ‰§è¡Œè¯·æ±‚
    return await adapter[action](params);
  }
}
```

### 4.2 SDKå°è£…è®¾è®¡

```typescript
// æ°´ç”µç…¤ç¼´è´¹SDKç¤ºä¾‹
class UtilityBillSDK implements LifeServiceAdapter {
  readonly serviceId = 'utility_bill';
  readonly serviceName = 'ç”Ÿæ´»ç¼´è´¹';
  readonly category = ServiceCategory.UTILITY;
  readonly supportedPayments = [
    PaymentChannel.WECHAT,
    PaymentChannel.ALIPAY,
    PaymentChannel.BANK_CARD
  ];

  private api: UtilityAPI;

  constructor(config: SDKConfig) {
    this.api = new UtilityAPI({
      baseUrl: config.baseUrl,
      appId: config.appId,
      signType: 'RSA2',
      publicKey: config.publicKey
    });
  }

  // æŸ¥è¯¢è´¦å•
  async query(params: {
    accountNumber: string;
    utilityType: 'water' | 'electricity' | 'gas';
    cityCode: string;
  }): Promise<BillInfo[]> {
    // è°ƒç”¨æœåŠ¡å•†API
    const response = await this.api.queryBill({
      account_no: params.accountNumber,
      bill_type: params.utilityType,
      city_code: params.cityCode
    });

    // æ ‡å‡†åŒ–å“åº”
    return response.bills.map(bill => ({
      billId: bill.bill_id,
      amount: bill.amount / 100, // åˆ†è½¬å…ƒ
      period: bill.bill_period,
      dueDate: bill.due_date,
      status: bill.status === 'UNPAID' ? 'unpaid' : 'paid',
      details: {
        usage: bill.usage,
        unitPrice: bill.unit_price,
        previousBalance: bill.prev_balance
      }
    }));
  }

  // åˆ›å»ºç¼´è´¹è®¢å•
  async createOrder(params: {
    billId: string;
    amount: number;
    userId: string;
  }): Promise<OrderResult> {
    const order = await this.api.createOrder({
      bill_id: params.billId,
      amount: Math.round(params.amount * 100),
      user_id: params.userId,
      notify_url: `${this.config.callbackUrl}/utility/notify`
    });

    return {
      orderId: order.order_no,
      amount: order.amount / 100,
      status: 'created',
      paymentParams: this.buildPaymentParams(order)
    };
  }
}
```

---

## 5. AIè¾…åŠ©å†³ç­–

### 5.1 æ™ºèƒ½æ¯”ä»·å¼•æ“

```typescript
// src/payment/ai/price-comparison.ts

interface PriceComparisonEngine {
  // å¤šå¹³å°æ¯”ä»·
  comparePrices(query: ProductQuery): Promise<PriceComparison[]>;

  // å†å²ä»·æ ¼è¶‹åŠ¿
  getPriceTrend(productId: string, days: number): Promise<PriceTrend>;

  // æœ€ä½³è´­ä¹°æ—¶æœºé¢„æµ‹
  predictBestTime(productId: string): Promise<TimePrediction>;
}

class AIPriceComparison implements PriceComparisonEngine {
  async comparePrices(query: ProductQuery): Promise<PriceComparison[]> {
    // å¹¶å‘æŸ¥è¯¢å¤šä¸ªå¹³å°
    const platforms = [
      'taobao', 'jd', 'pdd', 'tmall', 'suning'
    ];

    const results = await Promise.allSettled(
      platforms.map(async platform => {
        const adapter = this.getPlatformAdapter(platform);
        return await adapter.search(query);
      })
    );

    // æ ‡å‡†åŒ–å¹¶æ’åº
    const comparisons = results
      .filter(r => r.status === 'fulfilled')
      .map((r: any) => this.normalizeResult(r.value))
      .sort((a, b) => a.finalPrice - b.finalPrice);

    // AIåˆ†æ
    return await this.aiAnalyzeComparisons(comparisons);
  }

  private async aiAnalyzeComparisons(
    comparisons: PriceComparison[]
  ): Promise<PriceComparison[]> {
    const prompt = `
      åˆ†æä»¥ä¸‹å•†å“ä»·æ ¼æ¯”è¾ƒï¼Œç»™å‡ºè´­ä¹°å»ºè®®ï¼š
      ${JSON.stringify(comparisons, null, 2)}

      è€ƒè™‘å› ç´ ï¼š
      1. ä»·æ ¼ï¼ˆå«ä¼˜æƒ åˆ¸åï¼‰
      2. å•†å®¶ä¿¡èª‰
      3. ç‰©æµé€Ÿåº¦
      4. å”®åæœåŠ¡
      5. å†å²ä»·æ ¼è¶‹åŠ¿

      ä¸ºæ¯ä¸ªé€‰é¡¹æ·»åŠ aiRecommendationå­—æ®µï¼š
      - bestValue: æ€§ä»·æ¯”æœ€é«˜
      - fastest: ç‰©æµæœ€å¿«
      - mostReliable: æœ€å¯é 
      - notRecommended: ä¸æ¨èï¼ˆæ³¨æ˜åŸå› ï¼‰
    `;

    const analysis = await this.llm.generate(prompt);
    return this.mergeAnalysis(comparisons, analysis);
  }
}
```

### 5.2 æ™ºèƒ½æ¶ˆè´¹åŠ©æ‰‹

```typescript
// src/payment/ai/consumption-assistant.ts

interface ConsumptionAssistant {
  // é¢„ç®—ç®¡ç†
  setBudget(category: string, amount: number, period: 'daily' | 'weekly' | 'monthly'): Promise<void>;

  // æ¶ˆè´¹åˆ†æ
  analyzeSpending(userId: string, period: DateRange): Promise<SpendingAnalysis>;

  // æ™ºèƒ½æé†’
  getSmartReminders(userId: string): Promise<Reminder[]>;

  // æ¶ˆè´¹å»ºè®®
  getSpendingAdvice(userId: string): Promise<SpendingAdvice[]>;
}

class AIConsumptionAssistant implements ConsumptionAssistant {
  async analyzeSpending(
    userId: string,
    period: DateRange
  ): Promise<SpendingAnalysis> {
    // è·å–äº¤æ˜“æ•°æ®
    const transactions = await this.getTransactions(userId, period);

    // AIåˆ†æ
    const prompt = `
      åˆ†æç”¨æˆ·æ¶ˆè´¹æ•°æ®ï¼Œæä¾›æ´å¯Ÿï¼š

      äº¤æ˜“æ•°æ®ï¼š
      ${JSON.stringify(transactions)}

      è¯·æä¾›ï¼š
      1. æ¶ˆè´¹åˆ†ç±»å æ¯”
      2. å¼‚å¸¸æ¶ˆè´¹è¯†åˆ«
      3. ä¸ä¸Šæœˆå¯¹æ¯”
      4. é¢„ç®—æ‰§è¡Œæƒ…å†µ
      5. èŠ‚çœå»ºè®®

      è¾“å‡ºJSONæ ¼å¼ã€‚
    `;

    const analysis = await this.llm.generate(prompt, { format: 'json' });

    return {
      ...analysis,
      visualizations: this.generateCharts(analysis)
    };
  }

  async getSmartReminders(userId: string): Promise<Reminder[]> {
    const [bills, subscriptions, budgetStatus] = await Promise.all([
      this.getUpcomingBills(userId),
      this.getSubscriptions(userId),
      this.checkBudgetStatus(userId)
    ]);

    const reminders: Reminder[] = [];

    // è´¦å•æé†’
    bills.forEach(bill => {
      if (bill.dueDate.diff(Date.now(), 'days') <= 3) {
        reminders.push({
          type: 'bill_due',
          priority: 'high',
          title: `${bill.name}å³å°†åˆ°æœŸ`,
          content: `é‡‘é¢ï¼šÂ¥${bill.amount}ï¼Œæˆªæ­¢ï¼š${bill.dueDate}`,
          action: 'ç«‹å³ç¼´è´¹'
        });
      }
    });

    // è®¢é˜…ç»­è´¹æé†’
    subscriptions.forEach(sub => {
      if (sub.renewalDate.diff(Date.now(), 'days') <= 7) {
        reminders.push({
          type: 'subscription_renewal',
          priority: 'medium',
          title: `${sub.name}å³å°†ç»­è´¹`,
          content: `é‡‘é¢ï¼šÂ¥${sub.amount}/æœˆï¼Œä¸Šæ¬¡ä½¿ç”¨ï¼š${sub.lastUsed}`,
          action: 'ç®¡ç†è®¢é˜…'
        });
      }
    });

    // é¢„ç®—é¢„è­¦
    budgetStatus.forEach(budget => {
      if (budget.used / budget.limit > 0.8) {
        reminders.push({
          type: 'budget_warning',
          priority: budget.used / budget.limit > 0.95 ? 'high' : 'medium',
          title: `${budget.category}é¢„ç®—å³å°†è¶…æ”¯`,
          content: `å·²ä½¿ç”¨ ${(budget.used / budget.limit * 100).toFixed(0)}%`,
          action: 'æŸ¥çœ‹è¯¦æƒ…'
        });
      }
    });

    return reminders.sort((a, b) =>
      this.priorityWeight(b.priority) - this.priorityWeight(a.priority)
    );
  }
}
```

---

## 6. åˆè§„ä¸ç›‘ç®¡

### 6.1 åˆè§„è¦æ±‚çŸ©é˜µ

| åˆè§„é¡¹ | è¦æ±‚ | å®ç°æ–¹æ¡ˆ |
|--------|------|----------|
| **æ”¯ä»˜ç‰Œç…§** | éœ€æŒæœ‰ç¬¬ä¸‰æ–¹æ”¯ä»˜ç‰Œç…§æˆ–ä¸æŒç‰Œæœºæ„åˆä½œ | ä¸å¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ç­‰æŒç‰Œæœºæ„åˆä½œ |
| **å®åè®¤è¯** | ç”¨æˆ·éœ€å®Œæˆå®åè®¤è¯æ‰èƒ½ä½¿ç”¨æ”¯ä»˜åŠŸèƒ½ | æ¥å…¥å…¬å®‰/é“¶è¡Œå®åè®¤è¯æ¥å£ |
| **äº¤æ˜“é™é¢** | æ ¹æ®è®¤è¯çº§åˆ«è®¾ç½®ä¸åŒé™é¢ | æœªå®åÂ¥0/æ—¥ï¼ŒIç±»Â¥1000/æ—¥ï¼ŒIIç±»Â¥10000/æ—¥ï¼ŒIIIç±»Â¥50000/æ—¥ |
| **åæ´—é’±** | å¤§é¢äº¤æ˜“æŠ¥å‘Šã€å¯ç–‘äº¤æ˜“ç›‘æµ‹ | è‡ªåŠ¨åŒ–AMLç³»ç»Ÿï¼Œå¯ç–‘äº¤æ˜“è‡ªåŠ¨ä¸ŠæŠ¥ |
| **æ•°æ®å®‰å…¨** | ç¬¦åˆã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹ | æ•°æ®åŠ å¯†ã€æœ€å°æ”¶é›†ã€ç”¨æˆ·æˆæƒ |
| **ç­‰ä¿è¦æ±‚** | æ”¯ä»˜ç³»ç»Ÿéœ€é€šè¿‡ç­‰ä¿ä¸‰çº§ | æ¯å¹´å®‰å…¨æµ‹è¯„ï¼Œæ•´æ”¹ä¸åˆè§„é¡¹ |
| **PCI DSS** | æ”¯ä»˜å¡è¡Œä¸šæ•°æ®å®‰å…¨æ ‡å‡† | ç¬¦åˆPCI DSS Level 1è¦æ±‚ |

### 6.2 å®¡è®¡æ—¥å¿—

```typescript
// src/payment/compliance/audit-log.ts

interface AuditLogEntry {
  // åŸºæœ¬ä¿¡æ¯
  logId: string;
  timestamp: number;
  logType: AuditLogType;

  // ç”¨æˆ·ä¿¡æ¯
  userId: string;
  userType: 'personal' | 'enterprise';
  authLevel: number;

  // æ“ä½œä¿¡æ¯
  action: string;
  resource: string;
  resourceType: string;

  // è¯·æ±‚è¯¦æƒ…
  request: {
    ip: string;
    deviceId: string;
    userAgent: string;
    parameters: Record<string, unknown>;
  };

  // ç»“æœ
  result: 'success' | 'failure' | 'blocked';
  resultCode: string;
  resultMessage: string;

  // é£é™©è¯„ä¼°
  riskScore: number;
  riskFactors: string[];

  // ç­¾åï¼ˆé˜²ç¯¡æ”¹ï¼‰
  signature: string;
}

class AuditLogger {
  // è®°å½•å®¡è®¡æ—¥å¿—
  async log(entry: Omit<AuditLogEntry, 'logId' | 'signature'>): Promise<void> {
    const logEntry: AuditLogEntry = {
      ...entry,
      logId: this.generateLogId(),
      signature: ''
    };

    // è®¡ç®—ç­¾å
    logEntry.signature = await this.signLog(logEntry);

    // å­˜å‚¨ï¼ˆWORM - ä¸€æ¬¡å†™å…¥å¤šæ¬¡è¯»å–ï¼‰
    await this.storeLog(logEntry);

    // å®æ—¶ä¸ŠæŠ¥ç›‘ç®¡ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
    if (this.isRegulatoryReportable(entry)) {
      await this.reportToRegulator(logEntry);
    }
  }

  // éªŒè¯æ—¥å¿—å®Œæ•´æ€§
  async verifyLogIntegrity(logId: string): Promise<boolean> {
    const log = await this.getLog(logId);
    const computedSignature = await this.signLog(log);
    return log.signature === computedSignature;
  }
}
```

### 6.3 æ•°æ®éšç§ä¿æŠ¤

```typescript
// src/payment/compliance/data-protection.ts

class DataProtection {
  // æ•°æ®è„±æ•
  maskSensitiveData(data: unknown): unknown {
    const maskRules = [
      { path: 'cardNo', mask: (v: string) => v.slice(0, 4) + '****' + v.slice(-4) },
      { path: 'phone', mask: (v: string) => v.slice(0, 3) + '****' + v.slice(-4) },
      { path: 'idCard', mask: (v: string) => v.slice(0, 2) + '**********' + v.slice(-4) },
      { path: 'name', mask: (v: string) => v[0] + '*' + v.slice(2) }
    ];

    return this.applyMaskRules(data, maskRules);
  }

  // æ•°æ®æœ¬åœ°åŒ–å­˜å‚¨
  async ensureDataResidency(userId: string): Promise<void> {
    const userRegion = await this.getUserRegion(userId);

    // ç¡®ä¿æ•°æ®å­˜å‚¨åœ¨åˆè§„åŒºåŸŸ
    if (userRegion === 'CN') {
      await this.ensureStorageInChina(userId);
    } else if (userRegion === 'EU') {
      await this.ensureStorageInEU(userId);
    }
  }

  // æ•°æ®åˆ é™¤ï¼ˆGDPR/CCPA è¦æ±‚ï¼‰
  async deleteUserData(userId: string): Promise<void> {
    // 1. åˆ é™¤ç”¨æˆ·æ•°æ®
    await this.db.users.delete({ userId });

    // 2. åˆ é™¤äº¤æ˜“è®°å½•ï¼ˆä¿ç•™è„±æ•æ•°æ®ç”¨äºå®¡è®¡ï¼‰
    await this.db.transactions.update(
      { userId },
      { userId: null, masked: true }
    );

    // 3. åˆ é™¤æ”¯ä»˜å‡­è¯
    await this.keyManager.deleteUserKeys(userId);

    // 4. è®°å½•åˆ é™¤æ—¥å¿—
    await this.auditLogger.log({
      action: 'data_deletion',
      userId,
      result: 'success'
    });
  }
}
```

---

## 7. æ•°æ®åº“è®¾è®¡

```sql
-- æ”¯ä»˜è®¢å•è¡¨
CREATE TABLE payment_orders (
    id VARCHAR(36) PRIMARY KEY,
    order_no VARCHAR(64) NOT NULL UNIQUE,

    -- ç”¨æˆ·ä¿¡æ¯
    user_id VARCHAR(36) NOT NULL,
    device_id VARCHAR(64) NOT NULL,

    -- äº¤æ˜“ä¿¡æ¯
    amount DECIMAL(15, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'CNY',
    subject VARCHAR(256) NOT NULL,
    body TEXT,

    -- å•†æˆ·ä¿¡æ¯
    merchant_id VARCHAR(36),
    merchant_name VARCHAR(128),
    service_type VARCHAR(50), -- utility/dining/travel/shopping/health/finance

    -- æ”¯ä»˜æ¸ é“
    channel VARCHAR(20) NOT NULL, -- wechat/alipay/bank_card/dcep
    channel_order_no VARCHAR(64),

    -- çŠ¶æ€
    status VARCHAR(20) NOT NULL DEFAULT 'created',
    status_history JSON, -- çŠ¶æ€æµè½¬è®°å½•

    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    paid_at TIMESTAMP,
    expired_at TIMESTAMP,
    cancelled_at TIMESTAMP,

    -- æ‰©å±•ä¿¡æ¯
    extra_params JSON,
    metadata JSON,

    INDEX idx_user_id (user_id),
    INDEX idx_order_no (order_no),
    INDEX idx_channel_order (channel_order_no),
    INDEX idx_status_created (status, created_at),
    INDEX idx_paid_at (paid_at)
);

-- æ”¯ä»˜æ–¹å¼è¡¨
CREATE TABLE payment_methods (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,

    -- æ”¯ä»˜æ–¹å¼ç±»å‹
    type VARCHAR(20) NOT NULL, -- wechat/alipay/bank_card/dcep/apple_pay
    subtype VARCHAR(20), -- credit/debit/savings

    -- æ”¯ä»˜æ–¹å¼è¯¦æƒ…ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
    encrypted_data TEXT NOT NULL,

    -- æ˜¾ç¤ºä¿¡æ¯ï¼ˆè„±æ•ï¼‰
    display_name VARCHAR(64) NOT NULL,
    mask_info VARCHAR(64) NOT NULL, -- ****1234
    icon_url VARCHAR(256),

    -- å®‰å…¨è®¾ç½®
    is_default BOOLEAN DEFAULT FALSE,
    need_verify BOOLEAN DEFAULT TRUE,
    daily_limit DECIMAL(15, 2),
    single_limit DECIMAL(15, 2),

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'active',

    -- æ—¶é—´æˆ³
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP,

    INDEX idx_user_default (user_id, is_default),
    INDEX idx_status (status)
);

-- è´¦å•è®°å½•è¡¨
CREATE TABLE billing_records (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,

    -- è´¦å•ç±»å‹
    bill_type VARCHAR(20) NOT NULL, -- water/electricity/gas/mobile/broadband
    account_number VARCHAR(64) NOT NULL,

    -- è´¦å•ä¿¡æ¯
    bill_period VARCHAR(20) NOT NULL, -- 2026-02
    amount DECIMAL(10, 2) NOT NULL,
    usage_amount DECIMAL(10, 3),
    unit_price DECIMAL(10, 4),

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'unpaid', -- unpaid/paid/overdue
    paid_order_id VARCHAR(36),

    -- æ—¶é—´
    issue_date DATE NOT NULL,
    due_date DATE NOT NULL,
    paid_date DATE,

    -- è¯¦æƒ…
    details JSON,

    INDEX idx_user_account (user_id, account_number),
    INDEX idx_status_due (status, due_date),
    INDEX idx_paid_order (paid_order_id)
);

-- æœåŠ¡å•†é…ç½®è¡¨
CREATE TABLE service_providers (
    id VARCHAR(36) PRIMARY KEY,
    provider_code VARCHAR(32) NOT NULL UNIQUE,
    provider_name VARCHAR(128) NOT NULL,

    -- æœåŠ¡åˆ†ç±»
    category VARCHAR(32) NOT NULL,
    sub_categories JSON,

    -- APIé…ç½®
    api_base_url VARCHAR(256) NOT NULL,
    api_config JSON, -- åŠ å¯†å­˜å‚¨å¯†é’¥ç­‰

    -- æ”¯æŒèƒ½åŠ›
    supported_channels JSON,
    supported_regions JSON,

    -- è´¹ç‡
    fee_rate DECIMAL(5, 4) DEFAULT 0,
    fee_type VARCHAR(10) DEFAULT 'percentage', -- percentage/fixed

    -- çŠ¶æ€
    status VARCHAR(20) DEFAULT 'active',
    priority INT DEFAULT 100,

    -- ç»Ÿè®¡
    success_count INT DEFAULT 0,
    fail_count INT DEFAULT 0,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_category_status (category, status),
    INDEX idx_priority (priority)
);

-- é£æ§è®°å½•è¡¨
CREATE TABLE risk_control_logs (
    id VARCHAR(36) PRIMARY KEY,
    transaction_id VARCHAR(36) NOT NULL,

    -- é£æ§è¯„ä¼°
    risk_score INT NOT NULL,
    risk_level VARCHAR(10) NOT NULL, -- low/medium/high/critical
    decision VARCHAR(20) NOT NULL, -- allow/challenge/block

    -- è§¦å‘è§„åˆ™
    triggered_rules JSON,

    -- å¤„ç†ç»“æœ
    final_result VARCHAR(20),
    challenge_type VARCHAR(20), -- sms/biometric/password
    challenge_passed BOOLEAN,

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_transaction (transaction_id),
    INDEX idx_score_created (risk_score, created_at)
);
```

---

## 8. APIæ¥å£è®¾è®¡

```typescript
// æ”¯ä»˜å‘èµ·API
interface InitiatePaymentAPI {
  endpoint: 'POST /api/v1/payments/initiate';
  request: {
    amount: number;
    currency?: string;
    subject: string;
    body?: string;
    merchantId?: string;
    serviceType?: string;
    paymentChannel?: string;
    metadata?: Record<string, unknown>;
  };
  response: {
    orderId: string;
    orderNo: string;
    amount: number;
    status: string;
    paymentParams: {
      // å¾®ä¿¡æ”¯ä»˜å‚æ•°
      appId?: string;
      timeStamp?: string;
      nonceStr?: string;
      package?: string;
      signType?: string;
      paySign?: string;
      // æ”¯ä»˜å®å‚æ•°
      orderStr?: string;
      // å…¶ä»–æ¸ é“...
    };
    expireTime: number;
  };
}

// æ”¯ä»˜æŸ¥è¯¢API
interface QueryPaymentAPI {
  endpoint: 'GET /api/v1/payments/:orderId';
  response: {
    orderId: string;
    orderNo: string;
    amount: number;
    status: 'created' | 'paid' | 'failed' | 'cancelled' | 'refunded';
    paidAmount?: number;
    paidTime?: number;
    channel?: string;
    channelOrderNo?: string;
    refundRecords?: RefundRecord[];
  };
}

// è´¦å•æŸ¥è¯¢API
interface QueryBillsAPI {
  endpoint: 'GET /api/v1/bills';
  query: {
    type?: string;
    status?: string;
    startDate?: string;
    endDate?: string;
    page?: number;
    pageSize?: number;
  };
  response: {
    items: BillItem[];
    total: number;
    page: number;
    pageSize: number;
  };
}

// æœåŠ¡å•†åˆ—è¡¨API
interface ListServicesAPI {
  endpoint: 'GET /api/v1/services';
  query: {
    category?: string;
    region?: string;
  };
  response: {
    categories: ServiceCategory[];
    providers: ServiceProvider[];
  };
}

// é€€æ¬¾API
interface RefundAPI {
  endpoint: 'POST /api/v1/payments/:orderId/refund';
  request: {
    amount?: number; // ä¸ä¼ åˆ™å…¨é¢é€€æ¬¾
    reason: string;
  };
  response: {
    refundId: string;
    refundAmount: number;
    status: 'processing' | 'success' | 'failed';
  };
}
```

---

## 9. UI/UXè®¾è®¡

### 9.1 æ”¯ä»˜ç¡®è®¤ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ç¡®è®¤ä»˜æ¬¾                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚     â”‚      Â¥ 128.00               â”‚    â”‚
â”‚     â”‚                             â”‚    â”‚
â”‚     â”‚   ç”µè´¹ - 2026å¹´2æœˆ          â”‚    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚
â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚                                         â”‚
â”‚   ä»˜æ¬¾æ–¹å¼                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ ğŸ’³ æ‹›å•†é“¶è¡Œä¿¡ç”¨å¡(å°¾å·8888)    â–¶  â”‚
â”‚   â”‚    ä¼˜æƒ  Â¥2.00                 â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚                                         â”‚
â”‚   ä¼˜æƒ ä¿¡æ¯                              â”‚
â”‚   â€¢ éšæœºç«‹å‡æœ€é«˜Â¥5 âœ“                    â”‚
â”‚   â€¢ ä¿¡ç”¨å¡ç§¯åˆ†ç¿»å€ âœ“                    â”‚
â”‚                                         â”‚
â”‚   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚                                         â”‚
â”‚   å®ä»˜é‡‘é¢: Â¥126.00                     â”‚
â”‚                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚        ğŸ”’ ç¡®è®¤æ”¯ä»˜              â”‚  â”‚
â”‚   â”‚      ï¼ˆæŒ‡çº¹/é¢å®¹è¯†åˆ«ï¼‰          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 9.2 å®‰å…¨æç¤ºç»„ä»¶

```typescript
// å®‰å…¨æç¤ºç±»å‹
interface SecurityNotice {
  type: 'trusted_merchant' | 'first_payment' | 'large_amount' | 'risk_detected';
  level: 'info' | 'warning' | 'danger';
  title: string;
  message: string;
  actions?: SecurityAction[];
}

// ç¤ºä¾‹æç¤º
const securityNotices: Record<string, SecurityNotice> = {
  trustedMerchant: {
    type: 'trusted_merchant',
    level: 'info',
    title: 'å®˜æ–¹è®¤è¯å•†æˆ·',
    message: 'è¯¥å•†æˆ·å·²é€šè¿‡å¹³å°å®åè®¤è¯ï¼Œäº¤æ˜“å®‰å…¨æœ‰ä¿éšœ',
    icon: 'shield-check'
  },

  firstPayment: {
    type: 'first_payment',
    level: 'warning',
    title: 'é¦–æ¬¡æ”¯ä»˜æé†’',
    message: 'æ‚¨é¦–æ¬¡å‘è¯¥å•†æˆ·ä»˜æ¬¾ï¼Œè¯·ç¡®è®¤å•†æˆ·ä¿¡æ¯',
    actions: [
      { label: 'æŸ¥çœ‹å•†æˆ·è¯¦æƒ…', action: 'view_merchant' },
      { label: 'ç¡®è®¤æ— è¯¯', action: 'confirm' }
    ]
  },

  largeAmount: {
    type: 'large_amount',
    level: 'warning',
    title: 'å¤§é¢äº¤æ˜“éªŒè¯',
    message: 'äº¤æ˜“é‡‘é¢è¶…è¿‡Â¥5000ï¼Œéœ€è¦äºŒæ¬¡éªŒè¯',
    actions: [
      { label: 'çŸ­ä¿¡éªŒè¯', action: 'sms_verify' },
      { label: 'äººè„¸éªŒè¯', action: 'face_verify' }
    ]
  },

  riskDetected: {
    type: 'risk_detected',
    level: 'danger',
    title: 'âš ï¸ é£é™©è­¦å‘Š',
    message: 'ç³»ç»Ÿæ£€æµ‹åˆ°è¯¥äº¤æ˜“å­˜åœ¨å¼‚å¸¸ï¼Œå»ºè®®å–æ¶ˆ',
    actions: [
      { label: 'å–æ¶ˆäº¤æ˜“', action: 'cancel', primary: true },
      { label: 'åšæŒæ”¯ä»˜', action: 'proceed_anyway' }
    ]
  }
};
```

---

## 10. é£é™©æ§åˆ¶ç­–ç•¥

### 10.1 åˆ†å±‚é™é¢ä½“ç³»

```typescript
// é™é¢é…ç½®
interface LimitConfig {
  // è®¤è¯çº§åˆ«
  authLevel: 1 | 2 | 3;

  // å•ç¬”é™é¢
  singleLimit: {
    wechat: number;
    alipay: number;
    bankCard: number;
    dcep: number;
  };

  // æ—¥ç´¯è®¡é™é¢
  dailyLimit: {
    total: number;
    byChannel: Record<string, number>;
  };

  // æœˆç´¯è®¡é™é¢
  monthlyLimit: number;

  // ç‰¹æ®Šé™åˆ¶
  restrictions: {
    maxTransactionsPerMinute: number;
    maxNewMerchantsPerDay: number;
    requireVerificationAbove: number;
  };
}

// é™é¢é…ç½®è¡¨
const limitConfigs: Record<number, LimitConfig> = {
  1: { // Iç±»è´¦æˆ·ï¼ˆåŸºç¡€å®åï¼‰
    authLevel: 1,
    singleLimit: { wechat: 1000, alipay: 1000, bankCard: 500, dcep: 1000 },
    dailyLimit: { total: 1000, byChannel: {} },
    monthlyLimit: 10000,
    restrictions: {
      maxTransactionsPerMinute: 3,
      maxNewMerchantsPerDay: 5,
      requireVerificationAbove: 500
    }
  },

  2: { // IIç±»è´¦æˆ·ï¼ˆå®Œæ•´å®åï¼‰
    authLevel: 2,
    singleLimit: { wechat: 5000, alipay: 5000, bankCard: 10000, dcep: 5000 },
    dailyLimit: { total: 10000, byChannel: {} },
    monthlyLimit: 100000,
    restrictions: {
      maxTransactionsPerMinute: 10,
      maxNewMerchantsPerDay: 20,
      requireVerificationAbove: 2000
    }
  },

  3: { // IIIç±»è´¦æˆ·ï¼ˆé«˜çº§å®å+ç»‘å®šé“¶è¡Œå¡ï¼‰
    authLevel: 3,
    singleLimit: { wechat: 50000, alipay: 50000, bankCard: 50000, dcep: 50000 },
    dailyLimit: { total: 50000, byChannel: {} },
    monthlyLimit: 500000,
    restrictions: {
      maxTransactionsPerMinute: 20,
      maxNewMerchantsPerDay: 50,
      requireVerificationAbove: 10000
    }
  }
};
```

### 10.2 è®¾å¤‡ç»‘å®šä¸å®‰å…¨ç®¡ç†

```typescript
// src/payment/security/device-management.ts

class DeviceSecurityManager {
  // è®¾å¤‡ä¿¡ä»»è¯„åˆ†
  async calculateTrustScore(deviceId: string, userId: string): Promise<number> {
    const factors = await Promise.all([
      this.checkDeviceAge(deviceId),           // è®¾å¤‡ä½¿ç”¨æ—¶é•¿
      this.checkDeviceConsistency(deviceId, userId), // ä½¿ç”¨ä¸€è‡´æ€§
      this.checkSecurityFeatures(deviceId),    // å®‰å…¨åŠŸèƒ½å¯ç”¨
      this.checkRecentActivity(deviceId),      // è¿‘æœŸæ´»åŠ¨
      this.checkLocationConsistency(deviceId)  // åœ°ç‚¹ä¸€è‡´æ€§
    ]);

    // åŠ æƒè®¡ç®—
    const weights = [0.2, 0.3, 0.2, 0.15, 0.15];
    return factors.reduce((sum, f, i) => sum + f * weights[i], 0);
  }

  // æ–°è®¾å¤‡éªŒè¯æµç¨‹
  async verifyNewDevice(
    deviceId: string,
    userId: string,
    verificationMethod: 'sms' | 'email' | 'existing_device'
  ): Promise<VerificationResult> {
    // 1. å‘é€éªŒè¯
    const challenge = await this.sendVerification(userId, verificationMethod);

    // 2. ç­‰å¾…éªŒè¯
    const verified = await this.waitForVerification(challenge);

    if (verified) {
      // 3. è®¾å¤‡ç»‘å®š
      await this.bindDevice(deviceId, userId, {
        trustLevel: 'low', // æ–°è®¾å¤‡åˆå§‹ä¿¡ä»»åº¦ä½
        verificationMethod,
        verifiedAt: Date.now()
      });

      // 4. é™åˆ¶åˆå§‹æƒé™
      await this.applyNewDeviceRestrictions(deviceId, userId);

      return { success: true };
    }

    return { success: false, error: 'verification_failed' };
  }

  // å†»ç»“å¯ç–‘è®¾å¤‡
  async freezeDevice(deviceId: string, reason: string): Promise<void> {
    await this.db.devices.update(deviceId, {
      status: 'frozen',
      frozenAt: Date.now(),
      freezeReason: reason
    });

    // é€šçŸ¥ç”¨æˆ·
    await this.notifyUser(deviceId, {
      type: 'device_frozen',
      message: `æ‚¨çš„è®¾å¤‡å› ${reason}å·²è¢«å†»ç»“ï¼Œè¯·è”ç³»å®¢æœè§£å†»`,
      action: 'contact_support'
    });
  }
}
```

---

## 11. å®æ–½è·¯çº¿å›¾

| é˜¶æ®µ | æ—¶é—´ | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|------|------|--------|
| **Phase 1** | 2å‘¨ | æ”¯ä»˜æ ¸å¿ƒ + å¾®ä¿¡/æ”¯ä»˜å® | P0 |
| **Phase 2** | 2å‘¨ | å®‰å…¨ä½“ç³» + é£æ§å¼•æ“ | P0 |
| **Phase 3** | 2å‘¨ | ç”Ÿæ´»æœåŠ¡APIæ¥å…¥ | P1 |
| **Phase 4** | 2å‘¨ | AIæ¯”ä»· + æ¶ˆè´¹åˆ†æ | P1 |
| **Phase 5** | 2å‘¨ | åˆè§„å®¡è®¡ + æ•°æ®ä¿æŠ¤ | P1 |
| **Phase 6** | 1å‘¨ | æ€§èƒ½ä¼˜åŒ– + å‹åŠ›æµ‹è¯• | P2 |

---

## 12. å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| æ”¯ä»˜æˆåŠŸç‡ | > 99.9% | æ‰£é™¤ç”¨æˆ·ä¸»åŠ¨å–æ¶ˆ |
| å¹³å‡æ”¯ä»˜æ—¶é—´ | < 3ç§’ | ä»ç¡®è®¤åˆ°å®Œæˆ |
| é£é™©æ‹¦æˆªç‡ | > 95% | æ¬ºè¯ˆäº¤æ˜“è¯†åˆ« |
| è¯¯æ‹¦æˆªç‡ | < 0.1% | æ­£å¸¸äº¤æ˜“è¢«æ‹¦æˆª |
| ç”¨æˆ·æŠ•è¯‰ç‡ | < 0.01% | æ¯ä¸‡ç¬”äº¤æ˜“ |
| èµ„é‡‘æŸå¤±ç‡ | < 0.001% | å› å®‰å…¨é—®é¢˜çš„æŸå¤± |

---

*æ–‡æ¡£ç‰ˆæœ¬: 1.0*
*åˆ›å»ºæ—¥æœŸ: 2026-02-23*
