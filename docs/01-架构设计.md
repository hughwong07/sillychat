# 小傻瓜聊天工具 - 系统架构设计文档

## 1. 项目概述

### 1.1 项目定位
小傻瓜聊天工具是基于 OpenClaw 深度定制的 AI 原生聊天应用，专为个人和团队 AI 协作设计。核心特点是：
- **AI 优先**：从底层架构为 AI 交互优化
- **本地化优先**：数据本地存储，隐私可控
- **多平台**：支持 Windows、macOS、Android
- **开放集成**：与 OpenClaw 生态和 Skills 技能中心深度整合

### 1.2 核心特性
1. 下载即安装 OpenClaw 引擎
2. 每个账号可配置多个 AI 代理
3. 真人 + AI 分身双重身份
4. 项目/闲聊等多场景支持
5. Skills 技能中心同步
6. 端到端加密通信
7. 本地存储 + 云端备份

## 2. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           小傻瓜聊天工具 (XiaoShagua Chat)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Windows    │  │   macOS     │  │  Android    │  │    Web (挺傻网站)    │  │
│  │   桌面端     │  │   桌面端     │  │    移动端    │  │    (管理后台)        │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                │                     │            │
│         └────────────────┴────────────────┘                     │            │
│                          │                                      │            │
│              ┌───────────▼───────────┐                        │            │
│              │    统一通信协议层      │◄───────────────────────┘            │
│              │  (WebSocket + Protobuf)│   HTTP/HTTPS API                      │
│              └───────────┬───────────┘                                  │
│                          │                                             │
├──────────────────────────┼─────────────────────────────────────────────┤
│  核心引擎层               │                                              │
│  ┌───────────────────────▼───────────────────────────────────────────┐  │
│  │                    XiaoShagua Core (基于 OpenClaw)                  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐  │  │
│  │  │ Gateway  │ │  Agents  │ │  Skills  │ │  Memory  │ │ Storage │  │  │
│  │  │  网关服务 │ │  AI代理  │ │ 技能执行 │ │ 记忆系统 │ │ 存储管理│  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └─────────┘  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐             │  │
│  │  │ Channels │ │ Routing  │ │  Auth    │ │  Config  │             │  │
│  │  │ 通道管理 │ │ 消息路由 │ │ 权限认证 │ │ 配置管理 │             │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘             │  │
│  └──────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────┤
│  数据存储层                                                              │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌────────────────┐  │
│  │  SQLite DB   │ │  文件存储    │ │  配置存储    │ │  云端同步API   │  │
│  │ 聊天记录/元数据│ │ 图片/视频/文件│ │ YAML/JSON   │ │ 用户自选云服务 │  │
│  └──────────────┘ └──────────────┘ └──────────────┘ └────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## 3. 模块详细设计

### 3.1 Gateway 网关服务模块

基于 OpenClaw Gateway 改造，提供核心服务能力：

```typescript
// 核心组件
interface XSGatewayServer {
  // WebSocket/HTTP 服务
  wsServer: WebSocketServer;
  httpServer: HTTPServer;

  // 协议处理
  protocol: XSGProtocol;

  // 设备发现
  discovery: DiscoveryService;

  // 会话管理
  sessionManager: SessionManager;

  // 客户端连接管理
  clientManager: ClientManager;
}
```

**关键改造点**：
1. 简化通道管理，移除不需要的第三方通道（Telegram/WhatsApp 等）
2. 强化本地 WebSocket 通信
3. 增加多端同步协议
4. 集成 Skills 远程注册中心

### 3.2 Agents AI 代理模块

```typescript
interface XSAIAgent {
  // 唯一标识
  id: string;

  // 身份信息
  identity: {
    name: string;
    avatar: string;
    role: 'master' | 'assistant' | 'expert';
    personality?: string;
  };

  // AI 模型配置
  model: {
    provider: 'openclaw' | 'anthropic' | 'openai' | 'local';
    modelId: string;
    apiKey?: string;
    options?: ModelOptions;
  };

  // 能力配置
  capabilities: {
    skills: string[];
    tools: string[];
    memory: boolean;
    fileAccess: boolean;
  };

  // 权限级别
  permissionLevel: number; // 0-100, 主人为100
}
```

**AI 代理类型**：
1. **主人 AI**：用户主代理，拥有最高权限
2. **分身 AI**：用户创建的多个辅助 AI
3. **邀请 AI**：其他用户邀请的 AI

### 3.3 Channels 通道模块

简化版通道设计：

```typescript
interface XSChannel {
  id: string;
  type: 'direct' | 'group' | 'project';
  name: string;

  // 成员
  members: {
    userId: string;
    role: 'human' | 'ai' | 'hybrid';
    agentId?: string;
    permissions: Permission[];
  }[];

  // AI 配置
  aiConfig: {
    defaultAgent: string;
    allowedAgents: string[];
    scene: 'chat' | 'project' | 'meeting';
  };

  // 存储设置
  storage: {
    local: boolean;
    cloudSync: boolean;
    retention: number; // 保留天数
  };
}
```

### 3.4 Skills 技能模块

```typescript
interface XSSkill {
  id: string;
  name: string;
  description: string;
  version: string;

  // 来源
  source: {
    type: 'builtin' | 'remote' | 'local';
    url?: string;
    path?: string;
  };

  // 执行环境
  runtime: {
    type: 'nodejs' | 'python' | 'wasm';
    permissions: string[];
    sandbox: boolean;
  };

  // 触发方式
  triggers: {
    commands: string[];
    patterns: RegExp[];
    intents: string[];
  };
}
```

### 3.5 Storage 存储模块

```typescript
interface XSStorage {
  // 本地数据库
  local: {
    db: SQLiteDatabase;
    fileStore: FileSystemStorage;
  };

  // 云端配置
  cloud?: {
    provider: 's3' | 'oss' | 'onedrive' | 'custom';
    config: CloudConfig;
    syncMode: 'auto' | 'manual';
  };

  // 存储管理
  dedup: DeduplicationService;
  encryption: EncryptionService;
  sync: SyncService;
}
```

**文件存储结构**：
```
~/.xiaoshagua/
├── config/
│   ├── settings.yaml      # 用户设置
│   ├── agents.yaml        # AI代理配置
│   └── accounts.json      # 账号信息
├── data/
│   ├── chats.db           # SQLite 聊天记录
│   ├── index.db           # 文件索引
│   └── metadata/          # 元数据缓存
├── files/
│   ├── shared/            # 去重文件池
│   │   ├── aa/bb/ccddef...  # 哈希存储
│   │   └── ...
│   └── temp/              # 临时文件
├── cache/
│   ├── skills/            # 下载的技能
│   ├── avatars/           # 头像缓存
│   └── models/            # 本地模型
└── logs/                  # 运行日志
```

### 3.6 Memory 记忆模块

```typescript
interface XSMemory {
  // 短期记忆（当前会话）
  shortTerm: {
    contextWindow: Message[];
    maxTokens: number;
  };

  // 长期记忆（向量存储）
  longTerm: {
    store: VectorStore;
    embedding: EmbeddingModel;
    search: SemanticSearch;
  };

  // 文件记忆
  fileMemory: {
    index: FileIndex;
    summaries: Map<string, string>;
  };
}
```

## 4. 多平台架构

### 4.1 Windows 桌面端

**技术栈**：
- 框架：Electron / Tauri (Rust)
- UI：React/Vue + TailwindCSS
- 本地引擎：Node.js 运行时内嵌
- 存储：SQLite + 本地文件系统

**架构图**：
```
┌────────────────────────────────────────┐
│        Windows Application             │
│  ┌──────────────────────────────────┐  │
│  │         UI Layer (React)          │  │
│  │  ChatWindow | Settings | Skills  │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │    Desktop Bridge (Electron)      │  │
│  │  IPC | File Access | System Tray  │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │     XSG Core (Node.js)            │  │
│  │  Gateway | Agents | Storage       │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

### 4.2 macOS 桌面端

**技术栈**：
- SwiftUI 原生界面
- OpenClawKit 共享框架
- 后台 Node.js 引擎

**架构图**：
```
┌────────────────────────────────────────┐
│        macOS Application               │
│  ┌──────────────────────────────────┐  │
│  │     UI Layer (SwiftUI)            │  │
│  │  ChatView | Settings | Skills     │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │   OpenClawKit (Shared)            │  │
│  │  Protocol | Storage | Sync        │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │     XSG Core (Node.js)            │  │
│  │  Gateway | Agents | Storage       │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

### 4.3 Android 移动端

**技术栈**：
- Kotlin + Jetpack Compose
- 原生 NDK 模块（可选）
- WebView 用于部分界面

**架构图**：
```
┌────────────────────────────────────────┐
│       Android Application              │
│  ┌──────────────────────────────────┐  │
│  │   UI Layer (Jetpack Compose)      │  │
│  │  ChatScreen | Settings | Skills   │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │    Native Services (Kotlin)       │  │
│  │  Sync | Storage | Notifications   │  │
│  └──────────────────────────────────┘  │
│  ┌──────────────────────────────────┐  │
│  │   Embedded Engine (Node.js)       │  │
│  │  (Termux-like or custom build)    │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

## 5. 通信协议设计

### 5.1 协议栈

```
┌─────────────────────────────────────┐
│        Application Protocol          │
│   (XSG Protocol - JSON/Protobuf)     │
├─────────────────────────────────────┤
│         Transport Layer              │
│   WebSocket (primary) / HTTP (api)   │
├─────────────────────────────────────┤
│         Security Layer               │
│   TLS 1.3 + End-to-End Encryption    │
├─────────────────────────────────────┤
│         Network Layer                │
│   TCP/IP / mDNS (local discovery)    │
└─────────────────────────────────────┘
```

### 5.2 XSG Protocol 消息格式

```typescript
// 基础消息结构
interface XSGMessage {
  id: string;
  timestamp: number;
  type: 'chat' | 'command' | 'event' | 'system';

  // 发送者信息
  sender: {
    userId: string;
    agentId?: string;
    role: 'human' | 'ai';
    deviceId: string;
  };

  // 目标
  target: {
    channelId: string;
    threadId?: string;
  };

  // 内容
  content: {
    type: 'text' | 'image' | 'file' | 'skill';
    data: unknown;
    metadata?: Record<string, unknown>;
  };

  // 权限上下文
  auth: {
    level: number;
    signature?: string;
  };
}

// AI 指令消息
interface XSGAgentCommand {
  id: string;
  agentId: string;
  command: {
    type: 'chat' | 'skill' | 'tool';
    payload: unknown;
  };
  context: {
    history: Message[];
    files: string[];
    permissions: string[];
  };
}
```

### 5.3 设备发现协议

使用 mDNS + WebSocket 实现局域网设备发现：

```typescript
interface DeviceDiscovery {
  // 广播消息
  broadcast: {
    deviceId: string;
    deviceName: string;
    deviceType: 'desktop' | 'mobile' | 'web';
    capabilities: string[];
    endpoint: string; // WebSocket URL
    publicKey: string;
  };

  // 发现响应
  response: {
    challenge: string;
    signature: string;
  };
}
```

## 6. 安全架构

### 6.1 权限模型

```typescript
interface XSGPermission {
  // 用户级别
  user: {
    role: 'owner' | 'member' | 'guest';
    permissions: Permission[];
  };

  // AI 级别
  agent: {
    owner: string; // 所属用户
    level: number; // 0-100
    capabilities: Capability[];
    restrictions: Restriction[];
  };

  // 会话级别
  session: {
    channelPermissions: Map<string, Permission[]>;
    temporaryGrants: Grant[];
  };
}
```

### 6.2 权限级别定义

| 级别 | 名称 | 权限范围 |
|------|------|----------|
| 100 | 主人 | 完全控制所有 AI 和设置 |
| 80 | 管理员 | 管理群组和邀请 AI |
| 60 | 协作 AI | 执行技能、访问文件 |
| 40 | 只读 AI | 回答问题、读取历史 |
| 20 | 访客 AI | 仅限当前会话 |

### 6.3 数据加密

```typescript
interface XSGSecurity {
  // 传输加密
  transport: {
    protocol: 'TLS1.3';
    certPinning: boolean;
  };

  // 存储加密
  storage: {
    algorithm: 'AES-256-GCM';
    keyDerivation: 'Argon2id';
    keyStorage: 'Keychain' | 'Keystore' | 'DPAPI';
  };

  // 端到端加密（群聊）
  e2ee: {
    algorithm: 'Signal Protocol' | 'Double Ratchet';
    groupKeys: Map<string, Uint8Array>;
  };
}
```

## 7. 集成架构

### 7.1 与 OpenClaw 集成

```typescript
interface OpenClawIntegration {
  // 配置导入
  config: {
    import: () => Promise<OpenClawConfig>;
    sync: () => Promise<void>;
  };

  // 代理共享
  agents: {
    list: () => Promise<Agent[]>;
    import: (agentId: string) => Promise<void>;
    export: (agentId: string) => Promise<void>;
  };

  // 通道桥接
  channels: {
    bridgeToOpenClaw: (channelId: string) => Promise<void>;
    syncMessages: () => Promise<void>;
  };
}
```

### 7.2 与 Skills 技能中心集成

```typescript
interface SkillsCenterIntegration {
  // 同步机制
  sync: {
    pull: () => Promise<Skill[]>;
    push: (skill: Skill) => Promise<void>;
    autoUpdate: boolean;
  };

  // 技能市场
  marketplace: {
    browse: () => Promise<Skill[]>;
    install: (skillId: string) => Promise<void>;
    rate: (skillId: string, rating: number) => Promise<void>;
  };

  // 执行环境
  runtime: {
    sandbox: Sandbox;
    permissions: PermissionManager;
    logs: LogService;
  };
}
```

### 7.3 云端存储集成

```typescript
interface CloudStorageIntegration {
  providers: {
    s3: S3Provider;
    aliyunOSS: OSSProvider;
    onedrive: OneDriveProvider;
    dropbox: DropboxProvider;
    custom: WebDAVProvider;
  };

  sync: {
    mode: 'realtime' | 'periodic' | 'manual';
    conflictResolution: 'newest' | 'manual' | 'merge';
    bandwidthLimit?: number;
  };
}
```

## 8. 部署架构

### 8.1 打包结构

```
xiaoshagua-chat/
├── windows/
│   ├── XiaoShagua-Chat-Setup.exe    # Windows 安装包
│   └── XiaoShagua-Chat-Portable.zip # 便携版
├── macos/
│   └── XiaoShagua-Chat.dmg          # macOS 安装包
├── android/
│   └── xiaoshagua-chat.apk          # Android 安装包
└── core/
    └── xsg-core.tar.gz              # 核心引擎（跨平台）
```

### 8.2 自动更新流程

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Client App │───►│ Update Check │───►│  Version    │
│             │    │  (Daily)     │    │  Server     │
└─────────────┘    └─────────────┘    └──────┬──────┘
       │                                      │
       ▼                                      ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Restart   │◄───│   Install   │◄───│  Download   │
│   New Ver   │    │   Update    │    │   Package   │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 9. 开发路线图

### Phase 1: 核心引擎 (4周)
- [ ] 拆解 OpenClaw 核心模块
- [ ] 搭建 XSG Gateway 基础
- [ ] 实现本地存储系统
- [ ] 基础 AI 代理管理

### Phase 2: Windows 桌面端 (3周)
- [ ] Electron 应用框架
- [ ] 聊天界面开发
- [ ] 设置面板
- [ ] 安装包打包

### Phase 3: macOS 桌面端 (2周)
- [ ] SwiftUI 界面
- [ ] OpenClawKit 集成
- [ ] 签名和公证

### Phase 4: Android 移动端 (3周)
- [ ] Jetpack Compose UI
- [ ] 移动端适配
- [ ] 后台同步服务

### Phase 5: 高级功能 (4周)
- [ ] Skills 技能中心集成
- [ ] AI 分身系统
- [ ] 云端同步
- [ ] 端到端加密

### Phase 6: 优化与发布 (2周)
- [ ] 性能优化
- [ ] 安全审计
- [ ] 测试与修复
- [ ] 应用商店发布

## 10. 技术依赖

### 核心依赖
| 组件 | 版本 | 用途 |
|------|------|------|
| Node.js | >= 22 | 运行时 |
| TypeScript | >= 5.9 | 开发语言 |
| SQLite | 3.45+ | 本地数据库 |
| Zod | 3.23+ | 数据验证 |

### AI 模型支持
| 提供商 | 模型 | 接入方式 |
|--------|------|----------|
| OpenClaw | Clawd | 内置 |
| Anthropic | Claude 3.5/4 | API |
| OpenAI | GPT-4/GPT-4o | API |
| Ollama | 本地模型 | Local |

### 平台依赖
- **Windows**: Electron 33+, Windows 10 SDK
- **macOS**: Xcode 16+, macOS 14+
- **Android**: Android Studio Koala+, API 28+

---

*文档版本: 1.0*
*创建日期: 2026-02-23*
*最后更新: 2026-02-23*
