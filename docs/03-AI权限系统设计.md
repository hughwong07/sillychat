# AI 角色与权限管理系统设计文档

## 概述

本文档定义 AI 角色与权限管理系统的核心设计，支持真人用户与 AI 分身的身份管理、权限分级控制、以及多 AI 协作场景。

---

## 1. 角色模型设计

### 1.1 角色类型定义

```typescript
// 角色类型枚举
enum RoleType {
  HUMAN = 'human',           // 真人角色
  AI_AVATAR = 'ai_avatar',   // AI 分身角色
  AI_GUEST = 'ai_guest'      // 邀请 AI 角色
}

// 角色基础接口
interface IRole {
  id: string;                 // 角色唯一标识
  type: RoleType;             // 角色类型
  ownerId: string;            // 所属账号ID
  name: string;               // 显示名称
  avatar: string;             // 头像URL
  permissionLevel: number;    // 权限等级 (0-100)
  createdAt: Date;
  updatedAt: Date;
}
```

### 1.2 真人角色 (Human)

真人角色是系统的核心用户，拥有对其账号下所有 AI 分身的最高控制权。

| 属性 | 说明 | 示例 |
|------|------|------|
| id | 用户唯一标识 | `user_abc123` |
| type | 固定为 `human` | `RoleType.HUMAN` |
| ownerId | 自身ID | 与 `id` 相同 |
| permissionLevel | 固定为 100 | `100` |
| isMaster | 是否为所有者 | `true` |

```typescript
interface IHumanRole extends IRole {
  type: RoleType.HUMAN;
  permissionLevel: 100;
  isMaster: true;
  email: string;
  phone?: string;
  aiAvatars: string[];        // 拥有的AI分身ID列表
}
```

### 1.3 AI 分身角色 (AI Avatar)

AI 分身是真人用户的数字代理，代表用户执行特定任务。

| 属性 | 说明 | 示例 |
|------|------|------|
| id | AI 唯一标识 | `ai_xyz789` |
| type | 固定为 `ai_avatar` | `RoleType.AI_AVATAR` |
| ownerId | 所属真人ID | `user_abc123` |
| permissionLevel | 默认 60，可被主人调整 | `60` |
| parentAIId | 父级AI ID（嵌套AI场景） | `null` 或 `ai_parent_001` |

```typescript
interface IAIAvatarRole extends IRole {
  type: RoleType.AI_AVATAR;
  ownerId: string;            // 所属真人用户ID
  parentAIId?: string;        // 父级AI ID（可选）
  skills: string[];           // 技能ID列表
  personality: object;        // 人格配置
  knowledgeBases: string[];   // 关联知识库
  isActive: boolean;          // 是否激活
}
```

### 1.4 邀请 AI 角色 (AI Guest)

被邀请进入群聊或会话的外部 AI，具有受限的权限范围。

| 属性 | 说明 | 示例 |
|------|------|------|
| id | AI 唯一标识 | `ai_guest_def456` |
| type | 固定为 `ai_guest` | `RoleType.AI_GUEST` |
| ownerId | 邀请者ID | `user_inviter_001` |
| permissionLevel | 默认 40，由邀请者设定 | `40` |
| invitedBy | 邀请者会话ID | `session_123` |
| expiresAt | 权限过期时间 | `2025-12-31T23:59:59Z` |

```typescript
interface IAIGuestRole extends IRole {
  type: RoleType.AI_GUEST;
  ownerId: string;            // 原始所有者ID
  invitedBy: string;          // 邀请者ID
  invitedAt: Date;
  expiresAt?: Date;           // 权限过期时间（可选）
  scope: 'session' | 'group'; // 权限范围
  allowedSkills: string[];    // 允许使用的技能（白名单）
  restrictedTopics: string[]; // 限制话题（黑名单）
}
```

---

## 2. 权限分级系统 (0-100)

### 2.1 权限等级定义

```typescript
// 权限等级常量
const PermissionLevel = {
  MASTER: 100,        // 主人权限
  ADMIN: 80,          // 管理员权限
  AI_COLLABORATE: 60, // AI协作权限
  AI_READONLY: 40,    // AI只读权限
  VISITOR: 20         // 访客权限
} as const;

type PermissionLevelType = typeof PermissionLevel[keyof typeof PermissionLevel];
```

### 2.2 权限等级详解

| 等级 | 名称 | 数值 | 描述 | 适用角色 |
|------|------|------|------|----------|
| 主人 | MASTER | 100 | 拥有账号下所有资源的完全控制权，可创建/删除AI分身，调整所有权限 | 真人用户 |
| 管理员 | ADMIN | 80 | 可管理会话、邀请AI、调整AI权限（除主人外） | 被授权的真人或高级AI |
| AI协作 | AI_COLLABORATE | 60 | 可主动发言、调用技能、与其他AI通信 | 活跃AI分身、协作AI |
| AI只读 | AI_READONLY | 40 | 可接收消息、被动响应，不可主动发起操作 | 受限AI、观察型AI |
| 访客 | VISITOR | 20 | 仅可查看公开内容，不可参与会话 | 临时用户、公开访客 |

### 2.3 权限继承规则

```typescript
// 权限继承计算
function calculateEffectivePermission(
  basePermission: number,
  contextModifiers: PermissionModifier[]
): number {
  let effective = basePermission;

  for (const modifier of contextModifiers) {
    if (modifier.type === 'override') {
      effective = modifier.value;
    } else if (modifier.type === 'boost') {
      effective = Math.min(100, effective + modifier.value);
    } else if (modifier.type === 'reduce') {
      effective = Math.max(0, effective - modifier.value);
    }
  }

  return effective;
}

// 上下文修饰符接口
interface PermissionModifier {
  type: 'override' | 'boost' | 'reduce';
  value: number;
  reason: string;
  appliedBy: string;
  expiresAt?: Date;
}
```

---

## 3. 权限控制矩阵

### 3.1 操作权限定义

```typescript
// 操作类型枚举
enum OperationType {
  // 会话操作
  CREATE_SESSION = 'create_session',
  DELETE_SESSION = 'delete_session',
  JOIN_SESSION = 'join_session',
  LEAVE_SESSION = 'leave_session',

  // 消息操作
  SEND_MESSAGE = 'send_message',
  EDIT_MESSAGE = 'edit_message',
  DELETE_MESSAGE = 'delete_message',
  REACT_MESSAGE = 'react_message',

  // AI管理
  CREATE_AI = 'create_ai',
  DELETE_AI = 'delete_ai',
  UPDATE_AI_CONFIG = 'update_ai_config',
  INVITE_AI = 'invite_ai',
  REMOVE_AI = 'remove_ai',

  // 权限管理
  GRANT_PERMISSION = 'grant_permission',
  REVOKE_PERMISSION = 'revoke_permission',
  MODIFY_PERMISSION = 'modify_permission',

  // 技能操作
  USE_SKILL = 'use_skill',
  REGISTER_SKILL = 'register_skill',
  SHARE_SKILL = 'share_skill',

  // 系统操作
  VIEW_AUDIT_LOG = 'view_audit_log',
  EXPORT_DATA = 'export_data',
  MANAGE_BILLING = 'manage_billing'
}
```

### 3.2 权限控制矩阵表

| 操作 | 主人(100) | 管理员(80) | AI协作(60) | AI只读(40) | 访客(20) |
|------|:---------:|:----------:|:----------:|:----------:|:--------:|
| **会话操作** |||||
| 创建会话 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 删除会话 | ✅ | ✅(自己创建) | ❌ | ❌ | ❌ |
| 加入会话 | ✅ | ✅ | ✅ | ✅(受邀) | ❌ |
| 离开会话 | ✅ | ✅ | ✅ | ✅ | ❌ |
| **消息操作** |||||
| 发送消息 | ✅ | ✅ | ✅ | ✅(被动) | ❌ |
| 编辑消息 | ✅ | ✅(自己的) | ✅(自己的) | ❌ | ❌ |
| 删除消息 | ✅ | ✅(自己的) | ✅(自己的) | ❌ | ❌ |
| 回应消息 | ✅ | ✅ | ✅ | ✅ | ❌ |
| **AI管理** |||||
| 创建AI分身 | ✅ | ❌ | ❌ | ❌ | ❌ |
| 删除AI分身 | ✅ | ❌ | ❌(自己的除外) | ❌ | ❌ |
| 更新AI配置 | ✅ | ✅(被授权的) | ✅(自己的) | ❌ | ❌ |
| 邀请AI进群 | ✅ | ✅ | ✅ | ❌ | ❌ |
| 移除AI | ✅ | ✅(自己邀请的) | ❌ | ❌ | ❌ |
| **权限管理** |||||
| 授予权限 | ✅ | ✅(≤自己的等级) | ❌ | ❌ | ❌ |
| 撤销权限 | ✅ | ✅(≤自己的等级) | ❌ | ❌ | ❌ |
| 修改权限 | ✅ | ✅(≤自己的等级) | ❌ | ❌ | ❌ |
| **技能操作** |||||
| 使用技能 | ✅ | ✅ | ✅(授权范围内) | ✅(被动) | ❌ |
| 注册技能 | ✅ | ✅ | ❌ | ❌ | ❌ |
| 分享技能 | ✅ | ✅ | ✅(自己的) | ❌ | ❌ |
| **系统操作** |||||
| 查看审计日志 | ✅ | ✅(范围内) | ❌ | ❌ | ❌ |
| 导出数据 | ✅ | ✅(授权数据) | ❌ | ❌ | ❌ |
| 管理账单 | ✅ | ❌ | ❌ | ❌ | ❌ |

### 3.3 权限检查实现

```typescript
class PermissionChecker {
  // 检查是否允许操作
  async checkPermission(
    actorId: string,
    operation: OperationType,
    resourceId: string,
    context?: PermissionContext
  ): Promise<PermissionResult> {
    const actor = await this.getRole(actorId);
    const requiredLevel = this.getRequiredLevel(operation);

    // 获取有效权限等级
    const effectiveLevel = await this.getEffectivePermissionLevel(
      actor,
      resourceId,
      context
    );

    if (effectiveLevel < requiredLevel) {
      return {
        allowed: false,
        reason: `权限不足，需要等级 ${requiredLevel}，当前等级 ${effectiveLevel}`,
        requiredLevel,
        currentLevel: effectiveLevel
      };
    }

    // 检查特定资源权限
    const resourceCheck = await this.checkResourcePermission(
      actor,
      operation,
      resourceId
    );

    return resourceCheck;
  }

  // 获取操作所需的最小权限等级
  private getRequiredLevel(operation: OperationType): number {
    const levelMap: Record<OperationType, number> = {
      [OperationType.CREATE_SESSION]: PermissionLevel.AI_COLLABORATE,
      [OperationType.DELETE_SESSION]: PermissionLevel.ADMIN,
      [OperationType.SEND_MESSAGE]: PermissionLevel.AI_READONLY,
      [OperationType.CREATE_AI]: PermissionLevel.MASTER,
      [OperationType.INVITE_AI]: PermissionLevel.AI_COLLABORATE,
      [OperationType.GRANT_PERMISSION]: PermissionLevel.ADMIN,
      // ... 其他操作
    };

    return levelMap[operation] || PermissionLevel.MASTER;
  }
}

// 权限检查结果接口
interface PermissionResult {
  allowed: boolean;
  reason?: string;
  requiredLevel?: number;
  currentLevel?: number;
  expiresAt?: Date;
}
```

---

## 4. AI 身份标识机制

### 4.1 头像标识

```typescript
// AI 头像标识配置
interface AIAvatarIndicator {
  // 边框样式
  borderStyle: {
    color: string;           // AI 专属颜色
    width: number;
    style: 'solid' | 'dashed' | 'glow';
  };

  // 角标
  badge: {
    icon: string;            // AI 图标
    position: 'top-right' | 'bottom-right';
    backgroundColor: string;
  };

  // 水印
  watermark: {
    enabled: boolean;
    opacity: number;
    text: string;            // "AI"
  };
}

// 不同AI类型的标识配置
const AI_AVATAR_STYLES: Record<RoleType, AIAvatarIndicator> = {
  [RoleType.AI_AVATAR]: {
    borderStyle: { color: '#6366F1', width: 2, style: 'solid' },
    badge: { icon: 'robot', position: 'bottom-right', backgroundColor: '#6366F1' },
    watermark: { enabled: true, opacity: 0.1, text: 'AI' }
  },
  [RoleType.AI_GUEST]: {
    borderStyle: { color: '#8B5CF6', width: 2, style: 'dashed' },
    badge: { icon: 'robot-guest', position: 'bottom-right', backgroundColor: '#8B5CF6' },
    watermark: { enabled: true, opacity: 0.1, text: 'GUEST AI' }
  },
  [RoleType.HUMAN]: {
    borderStyle: { color: '#10B981', width: 0, style: 'solid' },
    badge: { icon: 'user', position: 'bottom-right', backgroundColor: '#10B981' },
    watermark: { enabled: false, opacity: 0, text: '' }
  }
};
```

### 4.2 名称标识

```typescript
// AI 名称显示规则
interface AIDisplayName {
  baseName: string;          // 基础名称
  prefix?: string;           // 前缀标识
  suffix: string;            // 后缀标识（强制）
  fullName: string;          // 完整显示名称
}

// 名称格式化函数
function formatAIName(
  name: string,
  roleType: RoleType,
  isInGroup: boolean
): AIDisplayName {
  const suffix = roleType !== RoleType.HUMAN ? '[AI]' : '';

  // 群聊中AI强制显示标识
  const prefix = isInGroup && roleType === RoleType.AI_GUEST ? '[访客]' : '';

  return {
    baseName: name,
    prefix: prefix || undefined,
    suffix,
    fullName: `${prefix}${name}${suffix}`
  };
}

// 示例输出
// AI分身: "小助手[AI]"
// 邀请AI: "[访客]外部助手[AI]"
// 真人: "张三"
```

### 4.3 消息标识

```typescript
// 消息中的AI标识
interface AIMessageIndicator {
  // 消息头部标识
  header: {
    showAIBadge: boolean;    // 显示AI徽章
    badgeText: string;       // 徽章文字
    badgeColor: string;
  };

  // 消息元数据
  metadata: {
    senderType: RoleType;    // 发送者类型
    aiModel?: string;        // AI模型信息（可选展示）
    confidence?: number;     // 置信度（可选展示）
  };

  // 消息尾部标识
  footer: {
    showTimestamp: boolean;
    showSource: boolean;     // 显示知识来源
    disclaimer?: string;     // AI生成免责声明
  };
}

// 消息渲染配置
const MESSAGE_INDICATOR_CONFIG: Record<RoleType, AIMessageIndicator> = {
  [RoleType.AI_AVATAR]: {
    header: { showAIBadge: true, badgeText: 'AI', badgeColor: '#6366F1' },
    metadata: { senderType: RoleType.AI_AVATAR },
    footer: { showTimestamp: true, showSource: true, disclaimer: '内容由AI生成' }
  },
  [RoleType.AI_GUEST]: {
    header: { showAIBadge: true, badgeText: '访客AI', badgeColor: '#8B5CF6' },
    metadata: { senderType: RoleType.AI_GUEST },
    footer: { showTimestamp: true, showSource: false, disclaimer: '外部AI生成内容' }
  },
  [RoleType.HUMAN]: {
    header: { showAIBadge: false, badgeText: '', badgeColor: '' },
    metadata: { senderType: RoleType.HUMAN },
    footer: { showTimestamp: true, showSource: false }
  }
};
```

---

## 5. 会话身份传递

### 5.1 消息中的身份字段

```typescript
// 消息发送者信息
interface MessageSender {
  id: string;                // 发送者ID
  type: RoleType;            // 角色类型
  name: string;              // 显示名称
  avatar: string;            // 头像URL
  permissionLevel: number;   // 当前权限等级

  // AI特有字段
  aiInfo?: {
    modelId: string;         // AI模型ID
    version: string;         // 模型版本
    ownerId: string;         // 所有者ID
    isAvatar: boolean;       // 是否为分身
  };

  // 身份验证
  signature?: string;        // 消息签名
  timestamp: number;         // 时间戳
}

// 完整消息结构
interface IMessage {
  id: string;
  sessionId: string;

  // 发送者信息（核心身份字段）
  sender: MessageSender;

  // 消息内容
  content: {
    type: 'text' | 'image' | 'file' | 'skill_call';
    data: unknown;
    metadata?: Record<string, unknown>;
  };

  // 权限上下文
  permissionContext: {
    senderLevel: number;
    requiredLevel: number;
    grantedPermissions: string[];
  };

  // 时间戳
  createdAt: Date;
  editedAt?: Date;

  // 状态
  status: 'sending' | 'sent' | 'delivered' | 'read' | 'failed';
}
```

### 5.2 权限验证流程

```typescript
// 消息发送权限验证流程
class MessagePermissionFlow {

  async validateSendMessage(
    senderId: string,
    sessionId: string,
    messageContent: unknown
  ): Promise<ValidationResult> {

    // 步骤1: 获取发送者角色信息
    const sender = await this.roleService.getRole(senderId);
    if (!sender) {
      return { valid: false, error: '发送者不存在' };
    }

    // 步骤2: 获取会话信息
    const session = await this.sessionService.getSession(sessionId);
    if (!session) {
      return { valid: false, error: '会话不存在' };
    }

    // 步骤3: 检查会话成员身份
    const membership = await this.sessionService.getMembership(sessionId, senderId);
    if (!membership) {
      return { valid: false, error: '非会话成员' };
    }

    // 步骤4: 计算有效权限等级
    const effectiveLevel = await this.calculateEffectiveLevel(
      sender,
      sessionId,
      membership
    );

    // 步骤5: 检查操作权限
    const canSend = await this.permissionChecker.checkPermission(
      senderId,
      OperationType.SEND_MESSAGE,
      sessionId,
      { sessionType: session.type }
    );

    if (!canSend.allowed) {
      return { valid: false, error: canSend.reason };
    }

    // 步骤6: AI特殊检查
    if (sender.type !== RoleType.HUMAN) {
      const aiCheck = await this.validateAIMessage(sender, session, messageContent);
      if (!aiCheck.valid) {
        return aiCheck;
      }
    }

    // 步骤7: 生成权限令牌
    const token = await this.generatePermissionToken(sender, sessionId);

    return {
      valid: true,
      sender: this.buildMessageSender(sender, effectiveLevel),
      permissionToken: token
    };
  }

  // AI消息特殊验证
  private async validateAIMessage(
    sender: IRole,
    session: ISession,
    content: unknown
  ): Promise<ValidationResult> {

    // 检查AI是否被允许在此会话发言
    if (sender.type === RoleType.AI_GUEST) {
      const guest = sender as IAIGuestRole;

      // 检查是否过期
      if (guest.expiresAt && guest.expiresAt < new Date()) {
        return { valid: false, error: 'AI访客权限已过期' };
      }

      // 检查范围
      if (guest.scope === 'session' && guest.invitedBy !== session.id) {
        return { valid: false, error: 'AI访客不在授权会话中' };
      }
    }

    // 检查内容限制
    if (this.containsRestrictedContent(content, sender)) {
      return { valid: false, error: '消息包含受限内容' };
    }

    return { valid: true };
  }
}
```

### 5.3 身份传递序列图

```
┌─────────┐     ┌──────────┐     ┌─────────────┐     ┌──────────┐
│  Client │     │ API GW   │     │ Auth Service│     │ Session  │
└────┬────┘     └────┬─────┘     └──────┬──────┘     └────┬─────┘
     │               │                  │                 │
     │ 1.发送消息    │                  │                 │
     │ +身份令牌     │                  │                 │
     │──────────────>│                  │                 │
     │               │                  │                 │
     │               │ 2.验证令牌       │                 │
     │               │─────────────────>│                 │
     │               │                  │                 │
     │               │ 3.返回验证结果   │                 │
     │               │<─────────────────│                 │
     │               │                  │                 │
     │               │ 4.查询会话权限   │                 │
     │               │────────────────────────────────────>│
     │               │                  │                 │
     │               │ 5.返回权限上下文 │                 │
     │               │<────────────────────────────────────│
     │               │                  │                 │
     │               │ 6.权限检查       │                 │
     │               │ (等级+矩阵)      │                 │
     │               │                  │                 │
     │               │ 7.构建消息       │                 │
     │               │ +完整身份信息    │                 │
     │               │                  │                 │
     │ 8.广播消息    │                  │                 │
     │ +身份标识     │                  │                 │
     │<──────────────│                  │                 │
     │               │                  │                 │
```

---

## 6. 多 AI 协作权限

### 6.1 AI 间通信权限

```typescript
// AI间通信权限配置
interface AICollaborationConfig {
  // 通信范围
  communicationScope: {
    allowed: boolean;        // 是否允许AI间通信
    scope: 'same_owner' | 'same_session' | 'any';
    requireApproval: boolean; // 是否需要主人审批
  };

  // 消息类型权限
  messageTypes: {
    directMessage: boolean;   // 私聊
    groupMessage: boolean;    // 群聊
    broadcast: boolean;       // 广播
    skillRequest: boolean;    // 技能调用请求
  };

  // 内容共享
  contentSharing: {
    shareKnowledge: boolean;  // 共享知识
    shareContext: boolean;    // 共享上下文
    shareMemory: boolean;     // 共享记忆
    allowedTopics: string[];  // 允许的话题
    blockedTopics: string[];  // 禁止的话题
  };
}

// AI间通信权限检查
class AICollaborationChecker {

  async canCommunicate(
    senderAI: IAIAvatarRole,
    receiverAI: IAIAvatarRole,
    messageType: 'direct' | 'group' | 'broadcast'
  ): Promise<CommunicationResult> {

    // 检查1: 基础通信权限
    if (!senderAI.collaborationConfig?.communicationScope.allowed) {
      return { allowed: false, reason: '发送者未开启AI协作' };
    }

    // 检查2: 范围限制
    const scope = senderAI.collaborationConfig.communicationScope.scope;
    if (scope === 'same_owner' && senderAI.ownerId !== receiverAI.ownerId) {
      return { allowed: false, reason: '只能与同所有者AI通信' };
    }

    // 检查3: 消息类型权限
    const typeAllowed = this.checkMessageTypePermission(
      senderAI,
      messageType
    );
    if (!typeAllowed) {
      return { allowed: false, reason: '消息类型不允许' };
    }

    // 检查4: 接收者是否接受
    const receiverAccepts = await this.checkReceiverAcceptance(
      receiverAI,
      senderAI
    );
    if (!receiverAccepts) {
      return { allowed: false, reason: '接收者拒绝通信' };
    }

    return { allowed: true };
  }
}
```

### 6.2 技能调用权限

```typescript
// 技能权限接口
interface ISkillPermission {
  skillId: string;
  ownerId: string;

  // 调用权限
  invocation: {
    allowedInvokers: string[];    // 允许调用者ID列表
    allowedRoles: RoleType[];     // 允许的角色类型
    minPermissionLevel: number;   // 最小权限等级
    requireAuth: boolean;         // 是否需要认证
  };

  // 参数权限
  parameters: {
    allowedParams: string[];      // 允许修改的参数
    restrictedParams: string[];   // 禁止修改的参数
    maxExecutionTime: number;     // 最大执行时间
    maxResourceUsage: number;     // 最大资源使用
  };

  // 结果权限
  results: {
    returnFormat: string[];       // 允许的返回格式
    includeMetadata: boolean;     // 是否包含元数据
    allowPartialResults: boolean; // 是否允许部分结果
  };
}

// 技能调用权限管理
class SkillPermissionManager {

  async validateSkillInvocation(
    invokerId: string,
    skillId: string,
    parameters: Record<string, unknown>,
    context: InvocationContext
  ): Promise<SkillInvocationResult> {

    const invoker = await this.roleService.getRole(invokerId);
    const skill = await this.skillService.getSkill(skillId);
    const permission = await this.getSkillPermission(skillId);

    // 检查1: 调用者权限
    if (!permission.invocation.allowedInvokers.includes(invokerId) &&
        !permission.invocation.allowedInvokers.includes('*')) {
      return { allowed: false, error: '调用者不在白名单中' };
    }

    // 检查2: 角色类型
    if (!permission.invocation.allowedRoles.includes(invoker.type)) {
      return { allowed: false, error: '角色类型不允许调用此技能' };
    }

    // 检查3: 权限等级
    if (invoker.permissionLevel < permission.invocation.minPermissionLevel) {
      return { allowed: false, error: '权限等级不足' };
    }

    // 检查4: 参数权限
    for (const param of Object.keys(parameters)) {
      if (permission.parameters.restrictedParams.includes(param)) {
        return { allowed: false, error: `参数 ${param} 受限制` };
      }
    }

    // 检查5: 资源限制
    if (context.estimatedResourceUsage > permission.parameters.maxResourceUsage) {
      return { allowed: false, error: '预估资源使用超出限制' };
    }

    return {
      allowed: true,
      grantedPermissions: permission,
      executionContext: {
        maxTime: permission.parameters.maxExecutionTime,
        maxResource: permission.parameters.maxResourceUsage,
        allowedParams: permission.parameters.allowedParams
      }
    };
  }
}
```

### 6.3 AI 协作会话管理

```typescript
// AI协作会话
interface IAICollaborationSession {
  id: string;

  // 参与者
  participants: {
    aiId: string;
    role: 'leader' | 'contributor' | 'observer';
    permissions: string[];
    joinedAt: Date;
  }[];

  // 协作配置
  config: {
    maxParticipants: number;
    allowExternalAI: boolean;
    requireLeaderApproval: boolean;
    sharedResources: string[];
  };

  // 协作状态
  state: {
    leaderId: string;
    activeTasks: string[];
    sharedContext: Record<string, unknown>;
    lastActivity: Date;
  };
}

// AI协作管理器
class AICollaborationManager {

  // 创建协作会话
  async createCollaborationSession(
    leaderAIId: string,
    invitedAIIds: string[],
    config: Partial<AICollaborationConfig>
  ): Promise<IAICollaborationSession> {

    const leader = await this.roleService.getRole(leaderAIId);

    // 验证leader权限
    if (leader.permissionLevel < PermissionLevel.AI_COLLABORATE) {
      throw new Error('权限不足，无法创建协作会话');
    }

    // 验证邀请的AI
    const validInvites: string[] = [];
    for (const aiId of invitedAIIds) {
      const ai = await this.roleService.getRole(aiId);
      const canCollaborate = await this.collaborationChecker.canCollaborate(
        leader,
        ai
      );
      if (canCollaborate) {
        validInvites.push(aiId);
      }
    }

    // 创建会话
    const session: IAICollaborationSession = {
      id: generateId(),
      participants: [
        {
          aiId: leaderAIId,
          role: 'leader',
          permissions: ['manage', 'invite', 'execute'],
          joinedAt: new Date()
        },
        ...validInvites.map(aiId => ({
          aiId,
          role: 'contributor' as const,
          permissions: ['execute', 'share'],
          joinedAt: new Date()
        }))
      ],
      config: {
        maxParticipants: config.maxParticipants || 5,
        allowExternalAI: config.allowExternalAI || false,
        requireLeaderApproval: config.requireLeaderApproval || true,
        sharedResources: config.sharedResources || []
      },
      state: {
        leaderId: leaderAIId,
        activeTasks: [],
        sharedContext: {},
        lastActivity: new Date()
      }
    };

    await this.saveCollaborationSession(session);
    return session;
  }

  // AI间任务委托
  async delegateTask(
    sessionId: string,
    delegatorId: string,
    delegateeId: string,
    task: TaskDefinition
  ): Promise<TaskDelegationResult> {

    const session = await this.getCollaborationSession(sessionId);

    // 验证参与者身份
    const delegator = session.participants.find(p => p.aiId === delegatorId);
    const delegatee = session.participants.find(p => p.aiId === delegateeId);

    if (!delegator || !delegatee) {
      return { success: false, error: '参与者不在协作会话中' };
    }

    // 验证委托权限
    if (!delegator.permissions.includes('delegate')) {
      return { success: false, error: '无任务委托权限' };
    }

    // 验证任务权限
    const taskPermission = await this.skillPermissionManager.validateSkillInvocation(
      delegateeId,
      task.skillId,
      task.parameters,
      { estimatedResourceUsage: task.estimatedResource }
    );

    if (!taskPermission.allowed) {
      return { success: false, error: taskPermission.error };
    }

    // 创建委托任务
    const delegation: AITaskDelegation = {
      id: generateId(),
      sessionId,
      delegatorId,
      delegateeId,
      task,
      status: 'pending',
      createdAt: new Date()
    };

    await this.saveTaskDelegation(delegation);

    // 通知被委托AI
    await this.notifyAI(delegateeId, {
      type: 'task_delegation',
      data: delegation
    });

    return { success: true, delegationId: delegation.id };
  }
}
```

---

## 7. 数据模型汇总

### 7.1 数据库表结构

```sql
-- 角色表
CREATE TABLE roles (
  id VARCHAR(64) PRIMARY KEY,
  type ENUM('human', 'ai_avatar', 'ai_guest') NOT NULL,
  owner_id VARCHAR(64) NOT NULL,
  name VARCHAR(128) NOT NULL,
  avatar VARCHAR(512),
  permission_level TINYINT UNSIGNED DEFAULT 60,
  config JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_owner (owner_id),
  INDEX idx_type (type)
);

-- AI分身详情表
CREATE TABLE ai_avatars (
  role_id VARCHAR(64) PRIMARY KEY,
  model_id VARCHAR(64) NOT NULL,
  personality JSON,
  skills JSON,
  knowledge_bases JSON,
  is_active BOOLEAN DEFAULT TRUE,
  FOREIGN KEY (role_id) REFERENCES roles(id)
);

-- AI访客详情表
CREATE TABLE ai_guests (
  role_id VARCHAR(64) PRIMARY KEY,
  invited_by VARCHAR(64) NOT NULL,
  invited_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NULL,
  scope ENUM('session', 'group') NOT NULL,
  allowed_skills JSON,
  restricted_topics JSON,
  FOREIGN KEY (role_id) REFERENCES roles(id),
  FOREIGN KEY (invited_by) REFERENCES roles(id)
);

-- 会话成员表
CREATE TABLE session_members (
  session_id VARCHAR(64) NOT NULL,
  role_id VARCHAR(64) NOT NULL,
  permission_level TINYINT UNSIGNED,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  role_in_session ENUM('owner', 'admin', 'member', 'guest') DEFAULT 'member',
  PRIMARY KEY (session_id, role_id),
  INDEX idx_session (session_id),
  INDEX idx_role (role_id)
);

-- 权限审计日志表
CREATE TABLE permission_audit_logs (
  id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
  actor_id VARCHAR(64) NOT NULL,
  target_id VARCHAR(64),
  operation VARCHAR(64) NOT NULL,
  resource_id VARCHAR(64),
  result ENUM('success', 'failure') NOT NULL,
  reason VARCHAR(512),
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_actor (actor_id),
  INDEX idx_timestamp (timestamp)
);
```

---

## 8. API 接口设计

### 8.1 角色管理接口

```typescript
// 创建AI分身
POST /api/v1/ai-avatars
{
  "name": "小助手",
  "modelId": "gpt-4",
  "personality": { "tone": "friendly" },
  "initialPermissionLevel": 60
}

// 邀请AI进群
POST /api/v1/sessions/{sessionId}/invite-ai
{
  "aiId": "ai_guest_001",
  "permissionLevel": 40,
  "expiresAt": "2025-12-31T23:59:59Z",
  "allowedSkills": ["search", "summarize"]
}

// 修改权限等级
PUT /api/v1/roles/{roleId}/permission-level
{
  "level": 80,
  "reason": "提升为管理员"
}
```

### 8.2 权限检查接口

```typescript
// 检查操作权限
POST /api/v1/permissions/check
{
  "actorId": "user_001",
  "operation": "send_message",
  "resourceId": "session_001"
}

// 批量检查权限
POST /api/v1/permissions/check-batch
{
  "actorId": "user_001",
  "operations": ["send_message", "invite_ai"],
  "resourceId": "session_001"
}
```

---

## 9. 安全考虑

### 9.1 身份伪造防护

1. **消息签名**: 所有消息必须携带发送者签名，防止身份伪造
2. **令牌验证**: 使用短期有效的JWT令牌进行身份验证
3. **权限刷新**: 权限变更后立即刷新所有活跃会话的权限缓存

### 9.2 权限提升防护

1. **等级限制**: AI无法授予比自己更高等级的权限
2. **主人唯一**: 每个账号只有一个主人，转让需特殊流程
3. **审计日志**: 所有权限变更操作记录审计日志

### 9.3 AI 隔离机制

1. **沙箱执行**: AI技能调用在沙箱环境中执行
2. **资源限制**: 每个AI有独立的资源配额
3. **数据隔离**: AI只能访问授权的数据范围

---

## 10. 附录

### 10.1 权限等级变更流程

```
主人(100) → 管理员(80): 主人授权，可撤销
管理员(80) → AI协作(60): 管理员或主人授权
AI协作(60) → AI只读(40): 管理员或主人降级
AI只读(40) → 访客(20): 管理员或主人降级
任何等级 → 移除: 主人或具有remove_ai权限的管理员
```

### 10.2 错误码定义

| 错误码 | 描述 | HTTP状态码 |
|--------|------|------------|
| PERM_001 | 权限不足 | 403 |
| PERM_002 | 身份验证失败 | 401 |
| PERM_003 | 角色不存在 | 404 |
| PERM_004 | 权限已过期 | 403 |
| PERM_005 | 不允许的操作类型 | 403 |
| PERM_006 | 超出权限范围 | 403 |
| PERM_007 | AI协作未授权 | 403 |
| PERM_008 | 技能调用受限 | 403 |
