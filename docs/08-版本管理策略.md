# SillyChat - 版本管理与自动更新策略

## 1. 版本号规范

### 1.1 语义化版本 (SemVer)

采用 `主版本号.次版本号.修订号` 格式：

```
版本格式: MAJOR.MINOR.PATCH-BUILD+METADATA
示例: 1.2.3-250223+oc2.1.0
```

| 版本段 | 说明 | 递增规则 |
|--------|------|----------|
| MAJOR | 主版本号 | 破坏性变更、API不兼容、重大架构调整 |
| MINOR | 次版本号 | 功能新增、向下兼容的功能扩展 |
| PATCH | 修订号 | Bug修复、性能优化、安全补丁 |
| BUILD | 构建号 | 6位日期码(YYMMDD)，每日递增 |
| METADATA | 元数据 | OpenClaw版本标识，如 `+oc2.1.0` |

### 1.2 与 OpenClaw 版本对应关系

```
小傻瓜版本: 1.2.3-250223+oc2.1.0
                        └────┘
                     OpenClaw 2.1.0
```

**版本追踪规则**：

| OpenClaw 更新类型 | 小傻瓜响应策略 | 版本变更 |
|-------------------|----------------|----------|
| MAJOR 升级 (如 1.x → 2.x) | 24小时内跟进 | MAJOR +1 |
| MINOR 升级 (如 2.0 → 2.1) | 12小时内跟进 | MINOR +1 |
| PATCH 升级 (如 2.1.0 → 2.1.1) | 6小时内跟进 | PATCH +1 |
| 安全补丁 | 2小时内紧急发布 | PATCH +1，标记为 hotfix |

**版本兼容性矩阵**：

| 小傻瓜版本 | 兼容 OpenClaw | 兼容 OpenCode |
|------------|---------------|---------------|
| 1.x.x | 1.0.0 - 1.9.9 | 0.5.0+ |
| 2.x.x | 2.0.0 - 2.9.9 | 1.0.0+ |

### 1.3 构建号规则

```
构建号格式: YYMMDD-NNN
示例: 250223-001

YY: 年份后两位 (25 = 2025)
MM: 月份 (02 = 二月)
DD: 日期 (23 = 23日)
NNN: 当日构建序号 (001-999)
```

**构建触发条件**：

```yaml
# .github/workflows/build.yml
build_triggers:
  # OpenClaw 发布新版本
  webhook_opencLAW_release:
    branches: [main]

  # OpenCode 发布新版本
  webhook_opencode_release:
    branches: [main]

  # 定时检查 (每6小时)
  schedule:
    - cron: '0 */6 * * *'

  # 手动触发
  workflow_dispatch:
    inputs:
      force_build:
        type: boolean
        default: false
```

## 2. 更新检查机制

### 2.1 检查频率

```typescript
// src/core/update/UpdateChecker.ts
interface UpdateCheckConfig {
  // 正常检查间隔
  normalInterval: 6 * 60 * 60 * 1000;  // 6小时

  // 紧急更新检查间隔
  urgentInterval: 15 * 60 * 1000;       // 15分钟

  // 启动后延迟检查
  startupDelay: 30 * 1000;              // 30秒

  // 用户手动检查冷却
  manualCheckCooldown: 5 * 60 * 1000;   // 5分钟
}
```

**检查时机**：

| 触发场景 | 检查策略 |
|----------|----------|
| 应用启动 | 延迟30秒后检查 |
| 定时检查 | 每6小时后台检查 |
| 用户手动 | 点击"检查更新"按钮 |
| 紧急推送 | 服务器推送立即检查 |
| 网络恢复 | 检测到网络恢复后检查 |

### 2.2 版本服务器

```yaml
# 版本服务器配置
version_server:
  primary: https://version.sillychat.app
  fallback:
    - https://version-backup1.sillychat.app
    - https://version-backup2.sillychat.app

  # 请求配置
  request:
    timeout: 10000        # 10秒超时
    retries: 3            # 失败重试3次
    retry_delay: 1000     # 重试间隔1秒
```

**版本信息 API**：

```typescript
// GET /api/v1/version/latest
interface VersionInfo {
  version: string;           // "1.2.3-250223-001"
  semver: {
    major: number;
    minor: number;
    patch: number;
  };
  buildNumber: string;       // "250223-001"
  openclawVersion: string;   // "2.1.0"

  // 各平台下载链接
  downloads: {
    windows: {
      x64: string;           // .exe 安装包
      x64_portable: string;  // 便携版
      x86?: string;
    };
    macos: {
      arm64: string;         // Apple Silicon
      x64: string;           // Intel
      universal: string;     // 通用版
    };
    android: {
      arm64: string;         // arm64-v8a
      armeabi: string;       // armeabi-v7a
      universal: string;     // 通用APK
    };
  };

  // 更新信息
  releaseNotes: {
    zh: string;              // 中文更新说明
    en: string;              // 英文更新说明
  };

  // 更新类型
  updateType: 'optional' | 'recommended' | 'critical' | 'security';

  // 强制更新阈值
  forceUpdateBelow: string;  // 低于此版本强制更新

  // 增量更新信息
  deltaUpdate: {
    fromVersion: string;     // 源版本
    patchUrl: string;        // 增量补丁URL
    patchSize: number;       // 补丁大小(字节)
  }[];

  // 签名信息
  signature: {
    algorithm: 'ed25519' | 'rsa-sha256';
    publicKey: string;
    signature: string;
  };

  // 发布时间
  releasedAt: string;        // ISO 8601

  // 过期时间
  expiresAt: string;         // 签名过期时间
}
```

### 2.3 增量更新

```typescript
// src/core/update/DeltaUpdater.ts
interface DeltaUpdateConfig {
  // 支持的最大版本跨度
  maxVersionGap: 5;

  // 增量更新大小阈值
  // 如果全量包小于此值，直接下载全量包
  fullPackageThreshold: 50 * 1024 * 1024;  // 50MB

  // 增量补丁算法
  patchAlgorithm: 'bsdiff' | 'hdiffpatch' | 'zstd';
}

// 增量更新流程
interface DeltaUpdateProcess {
  // 1. 检查是否有可用增量补丁
  checkDeltaPatch(currentVersion: string, targetVersion: string): Promise<DeltaPatchInfo>;

  // 2. 下载增量补丁
  downloadDeltaPatch(patchUrl: string, progressCallback: (p: number) => void): Promise<Buffer>;

  // 3. 应用补丁
  applyPatch(currentFiles: string[], patchData: Buffer): Promise<string[]>;

  // 4. 验证结果
  verifyPatchedFiles(files: string[], expectedHashes: Map<string, string>): Promise<boolean>;
}
```

**增量更新决策流程**：

```
检查更新
    │
    ▼
获取版本信息 ◄────────────────────────┐
    │                                  │
    ▼                                  │
是否有增量补丁?                        │
    │                                  │
    ├── 是 ──► 补丁大小 < 全量50%? ────┤
    │              │                   │
    │              ├── 是 ──► 使用增量更新
    │              │                   │
    │              └── 否 ──► 使用全量更新
    │                                  │
    └── 否 ──► 检查版本跨度 ───────────┤
                  │                   │
                  ├── 跨度 <= 5 ──────┤
                  │                   │
                  └── 跨度 > 5 ──────► 必须全量更新
```

## 3. 自动更新流程

### 3.1 下载更新

```typescript
// src/core/update/UpdateDownloader.ts
interface DownloadConfig {
  // 并发下载数
  concurrentDownloads: 4;

  // 分块大小
  chunkSize: 1024 * 1024;  // 1MB

  // 断点续传
  resumeEnabled: true;

  // 下载目录
  downloadDir: string;     // %APPDATA%/XiaoShagua/updates/

  // 限速配置
  speedLimit?: number;     // bytes/s, 0 = 不限速
}

// 下载管理器
class UpdateDownloader {
  // 开始下载
  async download(
    url: string,
    options: DownloadOptions
  ): Promise<DownloadResult> {
    // 1. 创建下载任务
    const task = await this.createTask(url);

    // 2. 分块下载
    const chunks = await this.downloadChunks(task, options);

    // 3. 合并文件
    const filePath = await this.mergeChunks(chunks);

    // 4. 验证签名
    await this.verifySignature(filePath, options.signature);

    // 5. 计算哈希
    const hash = await this.calculateHash(filePath);

    return { filePath, hash, size: task.totalSize };
  }
}
```

**下载进度回调**：

```typescript
interface DownloadProgress {
  // 下载状态
  status: 'pending' | 'downloading' | 'paused' | 'completed' | 'error';

  // 进度信息
  progress: {
    downloaded: number;    // 已下载字节
    total: number;         // 总字节
    percentage: number;    // 百分比 (0-100)
    speed: number;         // 当前速度 (bytes/s)
    eta: number;           // 预计剩余时间 (秒)
  };

  // 分块状态
  chunks: {
    index: number;
    status: 'pending' | 'downloading' | 'completed';
    downloaded: number;
    total: number;
  }[];
}
```

### 3.2 安装更新

**Windows 安装流程**：

```powershell
# scripts/update/install-windows.ps1
param(
    [string]$UpdatePackage,
    [string]$InstallDir = "$env:LOCALAPPDATA\XiaoShagua",
    [switch]$Silent
)

# 1. 验证安装包
$valid = Verify-Package -Path $UpdatePackage -PublicKey $env:XSG_PUBLIC_KEY
if (-not $valid) {
    throw "安装包签名验证失败"
}

# 2. 创建备份
$backupDir = "$env:LOCALAPPDATA\XiaoShagua\backups\$(Get-Date -Format 'yyyyMMdd-HHmmss')"
Backup-CurrentVersion -Source $InstallDir -Destination $backupDir

# 3. 关闭运行中的实例
Stop-RunningInstances -ProcessName "XiaoShagua"

# 4. 解压更新包
Expand-Archive -Path $UpdatePackage -DestinationPath "$env:TEMP\XSG_Update" -Force

# 5. 应用更新
Apply-Update -Source "$env:TEMP\XSG_Update" -Destination $InstallDir

# 6. 更新注册表
Update-RegistryEntries -InstallDir $InstallDir

# 7. 清理临时文件
Remove-Item -Path "$env:TEMP\XSG_Update" -Recurse -Force

# 8. 重启应用 (可选)
if (-not $Silent) {
    Start-Process -FilePath "$InstallDir\XiaoShagua.exe"
}
```

**macOS 安装流程**：

```bash
#!/bin/bash
# scripts/update/install-macos.sh

UPDATE_PKG="$1"
INSTALL_DIR="/Applications/XiaoShagua.app"
BACKUP_DIR="$HOME/Library/Application Support/XiaoShagua/backups/$(date +%Y%m%d-%H%M%S)"

# 1. 验证签名
codesign --verify --deep "$UPDATE_PKG" || exit 1

# 2. 备份当前版本
mkdir -p "$BACKUP_DIR"
ditto "$INSTALL_DIR" "$BACKUP_DIR/XiaoShagua.app"

# 3. 关闭应用
osascript -e 'quit app "XiaoShagua"'
sleep 2

# 4. 安装更新
ditto "$UPDATE_PKG" "$INSTALL_DIR"

# 5. 验证安装
codesign --verify --deep "$INSTALL_DIR"

# 6. 更新权限
chmod -R 755 "$INSTALL_DIR"
chown -R "$USER:admin" "$INSTALL_DIR"

# 7. 重启应用
open "$INSTALL_DIR"
```

**Android 安装流程**：

```kotlin
// android/app/src/main/java/com/sillychat/app/update/UpdateInstaller.kt
class UpdateInstaller(private val context: Context) {

    suspend fun installUpdate(apkFile: File): Result<Unit> {
        return try {
            // 1. 验证APK签名
            verifyApkSignature(apkFile)

            // 2. 检查存储权限
            if (!hasInstallPermission()) {
                requestInstallPermission()
                return Result.failure(SecurityException("需要安装权限"))
            }

            // 3. 创建安装Intent
            val intent = Intent(Intent.ACTION_VIEW).apply {
                val uri = FileProvider.getUriForFile(
                    context,
                    "${context.packageName}.fileprovider",
                    apkFile
                )
                setDataAndType(uri, "application/vnd.android.package-archive")
                addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
            }

            // 4. 启动安装
            context.startActivity(intent)

            Result.success(Unit)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }
}
```

### 3.3 回滚机制

```typescript
// src/core/update/RollbackManager.ts
interface RollbackConfig {
  // 保留备份数量
  maxBackups: 3;

  // 自动回滚触发条件
  autoRollback: {
    // 启动失败次数
    startupFailures: 3;
    // 启动超时时间
    startupTimeout: 30000;  // 30秒
    // 崩溃检测
    crashDetection: true;
  };
}

class RollbackManager {
  // 创建更新前备份
  async createBackup(): Promise<BackupInfo> {
    const backupId = generateBackupId();
    const backupPath = path.join(this.backupDir, backupId);

    await fs.copy(this.installDir, backupPath, {
      filter: (src) => !src.includes('updates') && !src.includes('cache')
    });

    // 保存版本元数据
    await fs.writeJson(path.join(backupPath, '.backup-meta.json'), {
      version: this.currentVersion,
      createdAt: new Date().toISOString(),
      platform: process.platform
    });

    return { id: backupId, path: backupPath };
  }

  // 执行回滚
  async rollback(backupId: string): Promise<void> {
    const backupPath = path.join(this.backupDir, backupId);
    const meta = await fs.readJson(path.join(backupPath, '.backup-meta.json'));

    // 1. 关闭当前实例
    await this.shutdownApp();

    // 2. 备份当前(失败的)版本
    const failedVersion = await this.createBackup();

    // 3. 恢复旧版本
    await fs.emptyDir(this.installDir);
    await fs.copy(backupPath, this.installDir);

    // 4. 记录回滚事件
    await this.logRollback({
      fromVersion: this.currentVersion,
      toVersion: meta.version,
      backupId,
      failedBackupId: failedVersion.id,
      timestamp: new Date().toISOString()
    });

    // 5. 重启应用
    await this.restartApp();
  }

  // 监控新版本稳定性
  async monitorStability(): Promise<void> {
    const startupAttempts = await this.getStartupAttempts();

    if (startupAttempts >= this.config.autoRollback.startupFailures) {
      console.error('新版本启动失败次数过多，触发自动回滚');
      const lastGoodBackup = await this.getLastGoodBackup();
      await this.rollback(lastGoodBackup.id);
    }
  }
}
```

**回滚触发条件**：

| 触发条件 | 检测方式 | 响应动作 |
|----------|----------|----------|
| 启动失败 | 检测启动超时或崩溃 | 记录失败，达到阈值后回滚 |
| 功能异常 | 健康检查API返回错误 | 提示用户，提供手动回滚 |
| 用户请求 | 用户在设置中选择"恢复上一版本" | 立即回滚 |
| 签名验证失败 | 安装时签名不匹配 | 拒绝安装，自动回滚 |

## 4. 多平台发布

### 4.1 Windows 发布流程

```yaml
# .github/workflows/release-windows.yml
name: Release - Windows

on:
  push:
    tags:
      - 'v*'

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build Core
        run: npm run build:core

      - name: Build Electron App
        run: npm run build:electron

      - name: Sign Executable
        run: |
          signtool sign /f ${{ secrets.WIN_CERT_PATH }} `
            /p ${{ secrets.WIN_CERT_PASSWORD }} `
            /tr http://timestamp.digicert.com `
            /td sha256 `
            /fd sha256 `
            release/XiaoShagua-Setup.exe

      - name: Create Portable Version
        run: |
          7z a -sfx release/XiaoShagua-Portable.exe release/win-unpacked/*

      - name: Generate Update Manifest
        run: node scripts/generate-manifest.js --platform=win32

      - name: Upload to CDN
        run: |
          aws s3 sync release/ s3://xsg-releases/windows/${{ github.ref_name }}/

      - name: Update Version Server
        run: |
          curl -X POST https://version.sillychat.app/api/v1/release \
            -H "Authorization: Bearer ${{ secrets.VERSION_API_TOKEN }}" \
            -d @manifest.json
```

**Windows 安装包结构**：

```
XiaoShagua-Setup-1.2.3.exe
├── app-64/
│   ├── XiaoShagua.exe      # 主程序
│   ├── resources/
│   │   ├── app.asar        # 应用代码
│   │   └── xsg-core/       # 核心引擎
│   └── node_modules/
├── Update.exe              # 更新程序
├── squirrel.exe            # 安装框架
└── resources/
    └── installer.nsh       # 安装脚本
```

### 4.2 macOS 签名公证

```yaml
# .github/workflows/release-macos.yml
name: Release - macOS

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Install certificates
        run: |
          echo ${{ secrets.MAC_CERT_P12 }} | base64 -d > certificate.p12
          security create-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain
          security import certificate.p12 -k build.keychain -P "${{ secrets.MAC_CERT_PASSWORD }}" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.KEYCHAIN_PASSWORD }}" build.keychain

      - name: Build Universal Binary
        run: |
          npm run build:macos:arm64
          npm run build:macos:x64
          lipo -create \
            release/arm64/XiaoShagua.app/Contents/MacOS/XiaoShagua \
            release/x64/XiaoShagua.app/Contents/MacOS/XiaoShagua \
            -output release/universal/XiaoShagua.app/Contents/MacOS/XiaoShagua

      - name: Sign App
        run: |
          codesign --deep --force --verify --verbose \
            --sign "Developer ID Application: XiaoShagua Inc" \
            --options runtime \
            release/universal/XiaoShagua.app

      - name: Create DMG
        run: |
          create-dmg \
            --volname "XiaoShagua Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "XiaoShagua-1.2.3.dmg" \
            release/universal/XiaoShagua.app

      - name: Notarize
        run: |
          xcrun notarytool submit "XiaoShagua-1.2.3.dmg" \
            --apple-id ${{ secrets.APPLE_ID }} \
            --password ${{ secrets.APPLE_APP_PASSWORD }} \
            --team-id ${{ secrets.APPLE_TEAM_ID }} \
            --wait

      - name: Staple Notarization
        run: |
          xcrun stapler staple "XiaoShagua-1.2.3.dmg"

      - name: Upload Release
        run: |
          aws s3 cp XiaoShagua-1.2.3.dmg s3://xsg-releases/macos/
```

**macOS 签名要求**：

| 组件 | 签名类型 | 说明 |
|------|----------|------|
| 主程序 | Developer ID Application | 应用签名 |
| 核心引擎 | 同上 | 嵌入式二进制 |
| DMG 安装包 | 无需签名 | 但需公证 |
| 自动更新程序 | 同上 | 独立签名 |

### 4.3 Android 应用商店

```yaml
# .github/workflows/release-android.yml
name: Release - Android

on:
  push:
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Keystore
        run: |
          echo ${{ secrets.ANDROID_KEYSTORE_BASE64 }} | base64 -d > android/app/sillychat.keystore

      - name: Build APK
        run: |
          cd android
          ./gradlew assembleRelease

      - name: Sign APK
        run: |
          apksigner sign \
            --ks android/app/sillychat.keystore \
            --ks-pass pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            --key-pass pass:${{ secrets.ANDROID_KEY_PASSWORD }} \
            --out app-release-signed.apk \
            app/build/outputs/apk/release/app-release-unsigned.apk

      - name: Verify Signature
        run: apksigner verify --verbose app-release-signed.apk

      - name: Build App Bundle
        run: |
          cd android
          ./gradlew bundleRelease

      - name: Sign AAB
        run: |
          jarsigner -keystore android/app/sillychat.keystore \
            -storepass ${{ secrets.ANDROID_KEYSTORE_PASSWORD }} \
            -keypass ${{ secrets.ANDROID_KEY_PASSWORD }} \
            app/build/outputs/bundle/release/app-release.aab \
            sillychat

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT }}
          packageName: com.sillychat.app
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: production
          whatsNewDirectory: distribution/whatsnew

      - name: Upload to Alternative Stores
        run: |
          # 华为应用市场
          curl -X POST https://appgallery.cloud.huawei.com/... \
            -F "file=@app-release-signed.apk"

          # 小米应用商店
          curl -X POST https://dev.mi.com/... \
            -F "apk=@app-release-signed.apk"
```

**Android 多渠道发布**：

| 渠道 | 包格式 | 自动上传 |
|------|--------|----------|
| Google Play | AAB | 是 |
| 华为应用市场 | APK | 是 |
| 小米应用商店 | APK | 是 |
| OPPO/vivo | APK | 是 |
| 官网直链 | APK | 是 |

## 5. 兼容性管理

### 5.1 API 兼容性

```typescript
// src/core/api/CompatibilityLayer.ts
interface APIVersion {
  version: string;
  deprecated: boolean;
  sunsetDate?: string;
  breakingChanges: string[];
}

class APICompatibilityManager {
  // API 版本注册表
  private apiRegistry: Map<string, APIVersion> = new Map([
    ['v1', { version: '1.0.0', deprecated: true, sunsetDate: '2025-06-01' }],
    ['v2', { version: '2.0.0', deprecated: false }],
    ['v3', { version: '3.0.0', deprecated: false }]
  ]);

  // 检查 API 兼容性
  checkCompatibility(clientVersion: string, apiVersion: string): CompatibilityResult {
    const api = this.apiRegistry.get(apiVersion);

    if (!api) {
      return { compatible: false, reason: 'API版本不存在' };
    }

    if (api.deprecated && new Date() > new Date(api.sunsetDate!)) {
      return { compatible: false, reason: 'API版本已停用' };
    }

    // 检查客户端最低版本要求
    const minClientVersion = this.getMinClientVersion(apiVersion);
    if (compareVersions(clientVersion, minClientVersion) < 0) {
      return {
        compatible: false,
        reason: `客户端版本过低，需要 ${minClientVersion}+`,
        requiredUpdate: true
      };
    }

    return { compatible: true };
  }
}
```

**OpenClaw API 适配器**：

```typescript
// src/core/adapters/OpenClawAdapter.ts
class OpenClawAdapter {
  private version: string;

  constructor(version: string) {
    this.version = version;
  }

  // 统一接口，内部处理版本差异
  async executeSkill(skillId: string, params: unknown): Promise<unknown> {
    // 根据 OpenClaw 版本调用不同实现
    if (this.version.startsWith('1.')) {
      return this.executeSkillV1(skillId, params);
    } else if (this.version.startsWith('2.')) {
      return this.executeSkillV2(skillId, params);
    } else {
      return this.executeSkillV3(skillId, params);
    }
  }

  private async executeSkillV1(skillId: string, params: unknown): Promise<unknown> {
    // OpenClaw 1.x 适配
    const adaptedParams = this.adaptParamsToV1(params);
    return this.callOpenClawAPI('/v1/skills/execute', adaptedParams);
  }

  private async executeSkillV2(skillId: string, params: unknown): Promise<unknown> {
    // OpenClaw 2.x 适配
    return this.callOpenClawAPI('/v2/skills/execute', params);
  }
}
```

### 5.2 数据迁移

```typescript
// src/core/migration/DataMigration.ts
interface Migration {
  fromVersion: string;
  toVersion: string;
  migrate: (db: Database) => Promise<void>;
}

class MigrationManager {
  private migrations: Migration[] = [
    {
      fromVersion: '1.0.0',
      toVersion: '1.1.0',
      migrate: async (db) => {
        // 添加新字段
        await db.exec(`
          ALTER TABLE agents ADD COLUMN personality TEXT;
          ALTER TABLE agents ADD COLUMN voice_enabled BOOLEAN DEFAULT 0;
        `);
      }
    },
    {
      fromVersion: '1.1.0',
      toVersion: '2.0.0',
      migrate: async (db) => {
        // 重大结构变更
        await db.exec(`
          CREATE TABLE agents_v2 AS SELECT * FROM agents;
          DROP TABLE agents;
          ALTER TABLE agents_v2 RENAME TO agents;

          CREATE INDEX idx_agents_owner ON agents(owner_id);
          CREATE INDEX idx_agents_role ON agents(role);
        `);
      }
    }
  ];

  async migrate(fromVersion: string, toVersion: string): Promise<void> {
    const db = await this.getDatabase();

    // 按顺序执行迁移
    const path = this.findMigrationPath(fromVersion, toVersion);

    for (const migration of path) {
      console.log(`执行迁移: ${migration.fromVersion} -> ${migration.toVersion}`);

      // 开始事务
      await db.run('BEGIN TRANSACTION');

      try {
        await migration.migrate(db);

        // 更新版本记录
        await db.run(
          'INSERT INTO schema_version (version, applied_at) VALUES (?, ?)',
          [migration.toVersion, new Date().toISOString()]
        );

        await db.run('COMMIT');
      } catch (error) {
        await db.run('ROLLBACK');
        throw new MigrationError(`迁移失败: ${migration.fromVersion} -> ${migration.toVersion}`, error);
      }
    }
  }
}
```

**数据迁移策略**：

| 迁移类型 | 处理方式 | 回滚支持 |
|----------|----------|----------|
| 新增字段 | ALTER TABLE ADD COLUMN | 是 |
| 删除字段 | 保留字段，标记废弃 | 是 |
| 表结构变更 | 创建新表，数据迁移 | 是 |
| 数据格式变更 | 转换脚本 | 是 |
| 破坏性变更 | 备份后迁移 | 否 |

### 5.3 配置兼容

```typescript
// src/core/config/ConfigCompatibility.ts
interface ConfigSchema {
  version: string;
  schema: ZodSchema;
  migrator?: (oldConfig: unknown) => unknown;
}

class ConfigCompatibilityManager {
  private schemas: ConfigSchema[] = [
    {
      version: '1.0',
      schema: z.object({
        theme: z.enum(['light', 'dark']),
        language: z.string()
      })
    },
    {
      version: '2.0',
      schema: z.object({
        appearance: z.object({
          theme: z.enum(['light', 'dark', 'auto']),
          fontSize: z.number().default(14)
        }),
        language: z.string(),
        notifications: z.object({
          enabled: z.boolean().default(true),
          sound: z.boolean().default(true)
        })
      }),
      migrator: (old: any) => ({
        appearance: {
          theme: old.theme,
          fontSize: 14
        },
        language: old.language,
        notifications: {
          enabled: true,
          sound: true
        }
      })
    }
  ];

  async loadConfig(): Promise<Config> {
    const rawConfig = await fs.readJson(this.configPath);
    const configVersion = rawConfig._version || '1.0';
    const currentVersion = '2.0';

    if (configVersion !== currentVersion) {
      // 需要迁移
      const migrated = await this.migrateConfig(rawConfig, configVersion, currentVersion);
      await this.saveConfig(migrated);
      return migrated;
    }

    // 验证配置
    const schema = this.getSchema(currentVersion);
    return schema.parse(rawConfig);
  }

  private async migrateConfig(
    config: unknown,
    fromVersion: string,
    toVersion: string
  ): Promise<Config> {
    let currentConfig = config;

    for (const schema of this.schemas) {
      if (compareVersions(schema.version, fromVersion) > 0 &&
          compareVersions(schema.version, toVersion) <= 0) {
        if (schema.migrator) {
          currentConfig = schema.migrator(currentConfig);
        }
      }
    }

    return { ...currentConfig, _version: toVersion };
  }
}
```

**配置版本管理**：

```yaml
# 配置结构示例
# ~/.sillychat/config/settings.yaml
_version: "2.0"           # 配置格式版本
lastModified: "2025-02-23T10:30:00Z"

appearance:
  theme: "auto"           # light | dark | auto
  fontSize: 14
  density: "comfortable"  # compact | comfortable | spacious

language: "zh-CN"

notifications:
  enabled: true
  sound: true
  desktop: true

# 旧版本兼容字段 (自动迁移)
# v1.0 中的 theme 字段自动映射到 appearance.theme
```

## 6. 版本发布检查清单

### 6.1 发布前检查

```markdown
## 版本发布检查清单

### 代码检查
- [ ] 所有测试通过
- [ ] 代码审查完成
- [ ] 安全扫描无高危漏洞
- [ ] 性能基准测试通过

### 版本检查
- [ ] 版本号已更新
- [ ] CHANGELOG 已更新
- [ ] OpenClaw 版本兼容性已验证
- [ ] 数据库迁移脚本已测试

### 构建检查
- [ ] Windows 构建成功
- [ ] macOS 构建成功
- [ ] Android 构建成功
- [ ] 安装包签名验证通过

### 发布检查
- [ ] 版本服务器已更新
- [ ] CDN 已同步
- [ ] 更新日志已发布
- [ ] 回滚方案已准备
```

### 6.2 紧急回滚流程

```bash
#!/bin/bash
# scripts/emergency-rollback.sh

VERSION_TO_ROLLBACK=$1
REASON=$2

echo "启动紧急回滚: $VERSION_TO_ROLLBACK"
echo "回滚原因: $REASON"

# 1. 标记当前版本为问题版本
curl -X POST https://version.sillychat.app/api/v1/block \
  -H "Authorization: Bearer $VERSION_API_TOKEN" \
  -d "{\"version\": \"$VERSION_TO_ROLLBACK\", \"reason\": \"$REASON\"}"

# 2. 恢复上一版本为当前版本
PREVIOUS_VERSION=$(git describe --tags --abbrev=0 HEAD~1)
echo "恢复版本: $PREVIOUS_VERSION"

# 3. 触发重新发布
git checkout $PREVIOUS_VERSION
gh workflow run release-all.yml --ref $PREVIOUS_VERSION

# 4. 通知团队
curl -X POST $SLACK_WEBHOOK_URL \
  -d "{\"text\": \"紧急回滚已执行: $VERSION_TO_ROLLBACK -> $PREVIOUS_VERSION\n原因: $REASON\"}"

echo "紧急回滚完成"
```

## 7. 监控与告警

```typescript
// src/core/monitoring/UpdateMetrics.ts
interface UpdateMetrics {
  // 更新检查统计
  checks: {
    total: number;
    success: number;
    failed: number;
  };

  // 下载统计
  downloads: {
    total: number;
    completed: number;
    failed: number;
    averageSpeed: number;
    averageTime: number;
  };

  // 安装统计
  installations: {
    total: number;
    success: number;
    failed: number;
    rollbackCount: number;
  };

  // 版本分布
  versionDistribution: Map<string, number>;
}

// 关键告警规则
const alertRules = [
  {
    name: '更新失败率过高',
    condition: (m: UpdateMetrics) => m.installations.failed / m.installations.total > 0.1,
    severity: 'critical'
  },
  {
    name: '回滚次数异常',
    condition: (m: UpdateMetrics) => m.installations.rollbackCount > 10,
    severity: 'critical'
  },
  {
    name: '版本检查失败',
    condition: (m: UpdateMetrics) => m.checks.failed / m.checks.total > 0.05,
    severity: 'warning'
  }
];
```

---

**文档版本**: 1.0
**创建日期**: 2026-02-23
**最后更新**: 2026-02-23
**适用平台**: Windows / macOS / Android
